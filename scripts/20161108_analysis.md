
# Analysis of count table (Darcie's 20161108_counts.txt)

```R
library(edgeR)
library(data.table)
library(ggplot2)
library(VennDiagram)
library(reshape)


# Enlarge the view width when printing tables
options(width = 250)


# Load table of counts into edgeR
data <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161108/20161108_counts.txt", header = T)
dim(data) # 97850    30


# Add first column to rownames
rownames(data) <- data[,1]
data <- data[2:30]
dim(data) # 97850    29


# Change to a DGE object
z <- DGEList(counts=data)


# How many counts are of each Pool?
reads_total <- sum(z$counts) # 318640713
reads_total_pool1 <- sum(z[,grepl("pool1", colnames(z$counts))]$counts) # 130440728
reads_total_pool2 <- sum(z[,grepl("pool2", colnames(z$counts))]$counts) # 129702799
reads_total_pool6 <- sum(z[,grepl("pool_6", colnames(z$counts))]$counts) # 23758482
reads_total_pool10 <- sum(z[,grepl("pool_10", colnames(z$counts))]$counts) # 20751729
reads_total_pool12 <- sum(z[,grepl("pool_12", colnames(z$counts))]$counts) # 13986975
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts)
  reads_pool_pct <- round(100*reads_pool/reads_total, 2)
  reads_pool_pool1 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool1", colnames(z$counts))]$counts)
  reads_pool_pct_pool1 <- round(100*reads_pool_pool1/reads_total_pool1, 2)
  reads_pool_pool2 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool2", colnames(z$counts))]$counts)
  reads_pool_pct_pool2 <- round(100*reads_pool_pool2/reads_total_pool2, 2)
  reads_pool_pool6 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool_6", colnames(z$counts))]$counts)
  reads_pool_pct_pool6 <- round(100*reads_pool_pool6/reads_total_pool6, 2)
  reads_pool_pool10 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool_10", colnames(z$counts))]$counts)
  reads_pool_pct_pool10 <- round(100*reads_pool_pool10/reads_total_pool10, 2)
  reads_pool_pool12 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool_12", colnames(z$counts))]$counts)
  reads_pool_pct_pool12 <- round(100*reads_pool_pool12/reads_total_pool12, 2)
  hps_pool <- length(rowSums(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts))
  print(sprintf("%s   %s   %s   %s   %s   %s   %s   %s   %s   %s   %s   %s   %s   %s", p, reads_pool, reads_pool_pct, reads_pool_pool1, reads_pool_pct_pool1, reads_pool_pool2, reads_pool_pct_pool2, reads_pool_pool6, reads_pool_pct_pool6, reads_pool_pool10, reads_pool_pct_pool10, reads_pool_pool12, reads_pool_pct_pool12, hps_pool))
}

#[1] "Pool1   77351138   24.28   75880154   58.17   1455533   1.12   6691   0.03   4795   0.02   3965   0.03   9478"
#[1] "Pool2   82608305   25.93   636296   0.49   81890391   63.14   23426   0.1   38658   0.19   19534   0.14   9468"
#[1] "Pool3   331951   0.1   84929   0.07   180539   0.14   8591   0.04   36148   0.17   21744   0.16   6294"
#[1] "Pool4   401392   0.13   125252   0.1   77089   0.06   17076   0.07   118920   0.57   63055   0.45   5186"
#[1] "Pool5   1479979   0.46   803941   0.62   335601   0.26   305816   1.29   24370   0.12   10251   0.07   8768"
#[1] "Pool6   17976728   5.64   713770   0.55   75731   0.06   17159757   72.23   18665   0.09   8805   0.06   9543"
#[1] "Pool7   1781159   0.56   516528   0.4   976302   0.75   261290   1.1   21270   0.1   5769   0.04   3612"
#[1] "Pool8   93181963   29.24   49147444   37.68   42558219   32.81   427352   1.8   675439   3.25   373509   2.67   9583"
#[1] "Pool9   1967290   0.62   563997   0.43   427326   0.33   108793   0.46   560376   2.7   306798   2.19   8901"
#[1] "Pool10   7863119   2.47   1038372   0.8   468500   0.36   203146   0.86   6106966   29.43   46135   0.33   9448"
#[1] "Pool11   16988234   5.33   315598   0.24   420680   0.32   2961727   12.47   9209239   44.38   4080990   29.18   7987"
#[1] "Pool12   16709455   5.24   614447   0.47   836888   0.65   2274817   9.57   3936883   18.97   9046420   64.68   9582"


# It looks good. There is just quite some Pool 11 in what is supposed to be Pools 10 (44.38%) and 12 (29.18%) and Pool 8 in Pool 1 (37.68%) and 2 (32.81%).


# Change column labels z$counts, change row labels z$samples, add group to z$samples, add Replicate to z$samples
treatments <- c(rep("no", 8), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3), c("DMSO", "PDS", "PhenDC3"))
timepoints <- c(rep("t0", 8), rep("t15", 21))
pools <- c(rep("Pool1", 3), rep("Pool2", 3), rep("Pool6", 2), rep("Pool1", 9), rep("Pool2", 9), c("Pool12", "Pool10", "Pool10"))
replicates <- c(rep(c("1", "2", "3"), 2), c("2", "3"), rep(c("1", "2", "3"), 6), c("2", "3", "1"))

colnames(z$counts) <- paste(timepoints, treatments, pools, replicates, sep="_")
rownames(z$samples) <- paste(timepoints, treatments, pools, replicates, sep="_")
z$samples$group <- paste(timepoints, treatments, pools, sep="_")
z$samples$Replicate <- replicates


# Select Pools 1, 2, 6, 10 and 12 as z1, z2, z6, z10 and z12, and redefine the corresponding $samples$lib.size
z1 <- z[grepl("Pool1$", rownames(z$counts)), grepl("Pool1_", colnames(z$counts))]
z1$samples$lib.size <- as.vector(colSums(z1$counts))
z2 <- z[grepl("Pool2$", rownames(z$counts)), grepl("Pool2", colnames(z$counts))]
z2$samples$lib.size <- as.vector(colSums(z2$counts))
z6 <- z[grepl("Pool6$", rownames(z$counts)), grepl("Pool6", colnames(z$counts))]
z6$samples$lib.size <- as.vector(colSums(z6$counts))
z10 <- z[grepl("Pool10$", rownames(z$counts)), grepl("Pool10", colnames(z$counts))]
z10$samples$lib.size <- as.vector(colSums(z10$counts))
z12 <- z[grepl("Pool12$", rownames(z$counts)), grepl("Pool12", colnames(z$counts))]
z12$samples$lib.size <- as.vector(colSums(z12$counts))


par(mfrow=c(2,1))
barplot(colSums(z$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z$counts)[rowSums(z$counts) > 1000000], decreasing=T)
#HEPACAM__sherwood_1u__2__2_Pool2    TAS2R42__sherwood__4__4_Pool2
#                         6247570                          1738633

# This is Brutal, this HEPACAM shRNA is present more than 6M times.


# Pool content table
z_plot <- data.table(z$counts)
setcolorder(z_plot, c("t0_no_Pool1_1", "t0_no_Pool1_2", "t0_no_Pool1_3", "t15_DMSO_Pool1_1", "t15_DMSO_Pool1_2", "t15_DMSO_Pool1_3", "t15_PDS_Pool1_1", "t15_PDS_Pool1_2", "t15_PDS_Pool1_3", "t15_PhenDC3_Pool1_1", "t15_PhenDC3_Pool1_2", "t15_PhenDC3_Pool1_3", "t0_no_Pool2_1", "t0_no_Pool2_2", "t0_no_Pool2_3", "t15_DMSO_Pool2_1", "t15_DMSO_Pool2_2", "t15_DMSO_Pool2_3", "t15_PDS_Pool2_1", "t15_PDS_Pool2_2", "t15_PDS_Pool2_3", "t15_PhenDC3_Pool2_1", "t15_PhenDC3_Pool2_2", "t15_PhenDC3_Pool2_3", "t0_no_Pool6_2", "t0_no_Pool6_3", "t15_PDS_Pool10_3", "t15_PhenDC3_Pool10_1", "t15_DMSO_Pool12_2"))
z_plot[, pool := as.numeric(sapply(rownames(z), function(x) gsub("Pool", "", tail(unlist(strsplit(x, "_")), n=1))))]

z_plot_pcts <- z_plot[, .(t0_no_Pool1_1 = 100*sum(t0_no_Pool1_1)/sum(z_plot[, t0_no_Pool1_1]),
t0_no_Pool1_2 = 100*sum(t0_no_Pool1_2)/sum(z_plot[, t0_no_Pool1_2]),
t0_no_Pool1_3 = 100*sum(t0_no_Pool1_3)/sum(z_plot[, t0_no_Pool1_3]),
t15_DMSO_Pool1_1 = 100*sum(t15_DMSO_Pool1_1)/sum(z_plot[, t15_DMSO_Pool1_1]),
t15_DMSO_Pool1_2 = 100*sum(t15_DMSO_Pool1_2)/sum(z_plot[, t15_DMSO_Pool1_2]),
t15_DMSO_Pool1_3 = 100*sum(t15_DMSO_Pool1_3)/sum(z_plot[, t15_DMSO_Pool1_3]),
t15_PDS_Pool1_1 = 100*sum(t15_PDS_Pool1_1)/sum(z_plot[, t15_PDS_Pool1_1]),
t15_PDS_Pool1_2 = 100*sum(t15_PDS_Pool1_2)/sum(z_plot[, t15_PDS_Pool1_2]),
t15_PDS_Pool1_3 = 100*sum(t15_PDS_Pool1_3)/sum(z_plot[, t15_PDS_Pool1_3]),
t15_PhenDC3_Pool1_1 = 100*sum(t15_PhenDC3_Pool1_1)/sum(z_plot[, t15_PhenDC3_Pool1_1]),
t15_PhenDC3_Pool1_2 = 100*sum(t15_PhenDC3_Pool1_2)/sum(z_plot[, t15_PhenDC3_Pool1_2]),
t15_PhenDC3_Pool1_3 = 100*sum(t15_PhenDC3_Pool1_3)/sum(z_plot[, t15_PhenDC3_Pool1_3]),
t0_no_Pool2_1 = 100*sum(t0_no_Pool2_1)/sum(z_plot[, t0_no_Pool2_1]),
t0_no_Pool2_2 = 100*sum(t0_no_Pool2_2)/sum(z_plot[, t0_no_Pool2_2]),
t0_no_Pool2_3 = 100*sum(t0_no_Pool2_3)/sum(z_plot[, t0_no_Pool2_3]),
t15_DMSO_Pool2_1 = 100*sum(t15_DMSO_Pool2_1)/sum(z_plot[, t15_DMSO_Pool2_1]),
t15_DMSO_Pool2_2 = 100*sum(t15_DMSO_Pool2_2)/sum(z_plot[, t15_DMSO_Pool2_2]),
t15_DMSO_Pool2_3 = 100*sum(t15_DMSO_Pool2_3)/sum(z_plot[, t15_DMSO_Pool2_3]),
t15_PDS_Pool2_1 = 100*sum(t15_PDS_Pool2_1)/sum(z_plot[, t15_PDS_Pool2_1]),
t15_PDS_Pool2_2 = 100*sum(t15_PDS_Pool2_2)/sum(z_plot[, t15_PDS_Pool2_2]),
t15_PDS_Pool2_3 = 100*sum(t15_PDS_Pool2_3)/sum(z_plot[, t15_PDS_Pool2_3]),
t15_PhenDC3_Pool2_1 = 100*sum(t15_PhenDC3_Pool2_1)/sum(z_plot[, t15_PhenDC3_Pool2_1]),
t15_PhenDC3_Pool2_2 = 100*sum(t15_PhenDC3_Pool2_2)/sum(z_plot[, t15_PhenDC3_Pool2_2]),
t15_PhenDC3_Pool2_3 = 100*sum(t15_PhenDC3_Pool2_3)/sum(z_plot[, t15_PhenDC3_Pool2_3]),
t0_no_Pool6_2 = 100*sum(t0_no_Pool6_2)/sum(z_plot[, t0_no_Pool6_2]),
t0_no_Pool6_3 = 100*sum(t0_no_Pool6_3)/sum(z_plot[, t0_no_Pool6_3]),
t15_PDS_Pool10_3 = 100*sum(t15_PDS_Pool10_3)/sum(z_plot[, t15_PDS_Pool10_3]),
t15_PhenDC3_Pool10_1 = 100*sum(t15_PhenDC3_Pool10_1)/sum(z_plot[, t15_PhenDC3_Pool10_1]),
t15_DMSO_Pool12_2 = 100*sum(t15_DMSO_Pool12_2)/sum(z_plot[, t15_DMSO_Pool12_2])),
keyby = pool]

write.table(z_plot_pcts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool1_Pool2_Pool6_Pool10_Pool12_library_content_table.txt", quote = FALSE, sep = "\t", row.names = FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool1_Pool2_Pool6_Pool10_Pool12_library_content_table.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161108/tables/")


# Pool content plot
z_plot_pcts_melt <- melt(z_plot_pcts, id = "pool", variable.name = "library", value.name = "pct")

gg <- ggplot(z_plot_pcts_melt[order(-pool)], aes(x = library, y = pct, fill = factor(pool))) +
geom_bar(stat="identity") +
xlab("") +
ylab("% Reads") +
theme_classic() +
scale_fill_discrete(name="Pool") +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_text(size = 16)) +
scale_x_discrete(labels = paste(paste(colnames(z_plot)[1:29], "(n =", as.character(colSums(z_plot)[1:29])), ")", sep=""))

ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161108_Pool1_Pool2_Pool6_Pool10_Pool12_library_content_plot.pdf", width = 16/2.54, height = 16/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161108_Pool1_Pool2_Pool6_Pool10_Pool12_library_content_plot.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161108/figures/")

# All Pool1 and Pool2 will be added to the previous 20160627
# t0_no_Pool6_2 will be added to 20160920 t0_no_Pool6_2
# t0_no_Pool6_3 will substitute the 20160920 t0_no_Pool6_3
# t15_PDS_Pool10_3 will be added to 20160629 t15_PDS_Pool10_3
# t15_PhenDC3_Pool10_1 will be added to 20160629 t15_PhenDC3_Pool10_1
# t15_DMSO_Pool12_2 will be added to 20161018 t15_DMSO_Pool12_2


# Write raw counts to tables (Pools 1, 2, 6, 10 and 12)
write.table(z1$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool1_counts.txt", quote = FALSE, sep = "\t")
write.table(z2$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool2_counts.txt", quote = FALSE, sep = "\t")
write.table(z6$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool6_counts.txt", quote = FALSE, sep = "\t")
write.table(z10$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool10_counts.txt", quote = FALSE, sep = "\t")
write.table(z12$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool12_counts.txt", quote = FALSE, sep = "\t")

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool1_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161108/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool2_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161108/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool6_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161108/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool10_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161108/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161108_Pool12_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161108/tables/")


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z1$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z1$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z1$counts)[rowSums(z1$counts) > 500000], decreasing=T)
#C16orf73__sherwood_1u__1__1_Pool1
#                           514579

par(mfrow=c(2,1))
barplot(colSums(z2$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z2$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z2$counts)[rowSums(z2$counts) > 1000000], decreasing=T)
#HEPACAM__sherwood_1u__2__2_Pool2    TAS2R42__sherwood__4__4_Pool2
#                         6219376                          1729829

par(mfrow=c(2,1))
barplot(colSums(z6$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z6$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z6$counts)[rowSums(z6$counts) > 50000], decreasing=T)
#TAOK1__4__3_Pool6
#            56109

par(mfrow=c(2,1))
barplot(colSums(z10$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z10$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z10$counts)[rowSums(z10$counts) > 60000], decreasing=T)
#GPKOW__6__4_Pool10
#             70301

par(mfrow=c(2,1))
barplot(colSums(z12$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z12$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z12$counts)[rowSums(z12$counts) > 25000], decreasing=T)
#ZNF713__7__4_Pool12
#              29405

```



# Analysis of count table (Katie's 20161109_counts.txt)

```R
library(edgeR)
library(data.table)
library(ggplot2)
library(VennDiagram)
library(reshape)


# Enlarge the view width when printing tables
options(width = 250)


# Load table of counts into edgeR
data <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161109/20161109_counts.txt", header = T)
dim(data) # 98067    32


# Add first column to rownames
rownames(data) <- data[,1]
data <- data[2:32]
dim(data) # 98067    31


# Change to a DGE object
z <- DGEList(counts=data)


# How many counts are of each Pool?
reads_total <- sum(z$counts) # 299059824
reads_total_pool3 <- sum(z[,grepl("pool3", colnames(z$counts))|grepl("pool_3", colnames(z$counts))]$counts) # 36905202
reads_total_pool4 <- sum(z[,grepl("pool4", colnames(z$counts))]$counts) # 20762675
reads_total_pool5 <- sum(z[,grepl("P5", colnames(z$counts))]$counts) # 119615491
reads_total_pool10 <- sum(z[,grepl("P10", colnames(z$counts))]$counts) # 111199418
reads_total_pool11 <- sum(z[,grepl("pool_11", colnames(z$counts))]$counts) # 10577038
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts)
  reads_pool_pct <- round(100*reads_pool/reads_total, 2)
  reads_pool_pool3 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool3", colnames(z$counts))|grepl("pool_3", colnames(z$counts))]$counts)
  reads_pool_pct_pool3 <- round(100*reads_pool_pool3/reads_total_pool3, 2)
  reads_pool_pool4 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool4", colnames(z$counts))]$counts)
  reads_pool_pct_pool4 <- round(100*reads_pool_pool4/reads_total_pool4, 2)
  reads_pool_pool5 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("P5", colnames(z$counts))]$counts)
  reads_pool_pct_pool5 <- round(100*reads_pool_pool5/reads_total_pool5, 2)
  reads_pool_pool10 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("P10", colnames(z$counts))]$counts)
  reads_pool_pct_pool10 <- round(100*reads_pool_pool10/reads_total_pool10, 2)
  reads_pool_pool11 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool_11", colnames(z$counts))]$counts)
  reads_pool_pct_pool11 <- round(100*reads_pool_pool11/reads_total_pool11, 2)
  hps_pool <- length(rowSums(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts))
  print(sprintf("%s   %s   %s   %s   %s   %s   %s   %s   %s   %s   %s   %s   %s   %s", p, reads_pool, reads_pool_pct, reads_pool_pool3, reads_pool_pct_pool3, reads_pool_pool4, reads_pool_pct_pool4, reads_pool_pool5, reads_pool_pct_pool5, reads_pool_pool10, reads_pool_pct_pool10, reads_pool_pool11, reads_pool_pct_pool11, hps_pool))
}

#[1] "Pool1   263720   0.09   17570   0.05   27485   0.13   136723   0.11   79859   0.07   2083   0.02   6791"
#[1] "Pool2   681968   0.23   138100   0.37   68113   0.33   211502   0.18   245546   0.22   18707   0.18   8816"
#[1] "Pool3   11749398   3.93   11277726   30.56   64687   0.31   175268   0.15   206993   0.19   24724   0.23   9476"
#[1] "Pool4   13907151   4.65   213972   0.58   12749227   61.4   649308   0.54   220523   0.2   74121   0.7   7995"
#[1] "Pool5   94134538   31.48   105546   0.29   290494   1.4   82005306   68.56   11717951   10.54   15241   0.14   8859"
#[1] "Pool6   1475848   0.49   47017   0.13   25285   0.12   1144175   0.96   246204   0.22   13167   0.12   6454"
#[1] "Pool7   2304637   0.77   232149   0.63   75421   0.36   1359702   1.14   630774   0.57   6591   0.06   4083"
#[1] "Pool8   70310595   23.51   6519398   17.67   6354132   30.6   29164761   24.38   27837992   25.03   434312   4.11   9579"
#[1] "Pool9   3267742   1.09   907480   2.46   568824   2.74   784914   0.66   650609   0.59   355915   3.36   8963"
#[1] "Pool10   68548096   22.92   260911   0.71   131786   0.63   1974342   1.65   66118235   59.46   62822   0.59   9494"
#[1] "Pool11   20993773   7.02   11806012   31.99   61422   0.3   778695   0.65   1496330   1.35   6851314   64.78   7981"
#[1] "Pool12   11422358   3.82   5379321   14.58   345799   1.67   1230795   1.03   1748402   1.57   2718041   25.7   9576"


# It looks good. There is still quite some Pool 8 contamination and Pool 11 contamination too.


# Change column labels z$counts, change row labels z$samples, add group to z$samples, add Replicate to z$samples
treatments <- c("DMSO", rep("no", 10), rep("PhenDC3", 2), rep(c(rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)),2))
timepoints <- c("t15", rep("t0", 10), rep("t15", 20))
pools <- c("Pool11", "Pool3", "Pool3", "Pool4", "Pool4", rep("Pool5", 3), rep("Pool10", 3), "Pool3", "Pool3", rep("Pool5", 9), rep("Pool10", 9))
replicates <- c("3", "2", "3", "1", "2", rep(c("1", "2", "3"), 2), "1", "3", rep(c("1", "2", "3"), 6))

colnames(z$counts) <- paste(timepoints, treatments, pools, replicates, sep="_")
rownames(z$samples) <- paste(timepoints, treatments, pools, replicates, sep="_")
z$samples$group <- paste(timepoints, treatments, pools, sep="_")
z$samples$Replicate <- replicates


# Select Pools 3, 4, 5, 10 and 11 as z3, z4, z5, z10 and z11, and redefine the corresponding $samples$lib.size
z3 <- z[grepl("Pool3$", rownames(z$counts)), grepl("Pool3", colnames(z$counts))]
z3$samples$lib.size <- as.vector(colSums(z3$counts))
z4 <- z[grepl("Pool4$", rownames(z$counts)), grepl("Pool4", colnames(z$counts))]
z4$samples$lib.size <- as.vector(colSums(z4$counts))
z5 <- z[grepl("Pool5$", rownames(z$counts)), grepl("Pool5", colnames(z$counts))]
z5$samples$lib.size <- as.vector(colSums(z5$counts))
z10 <- z[grepl("Pool10$", rownames(z$counts)), grepl("Pool10", colnames(z$counts))]
z10$samples$lib.size <- as.vector(colSums(z10$counts))
z11 <- z[grepl("Pool11$", rownames(z$counts)), grepl("Pool11", colnames(z$counts))]
z11$samples$lib.size <- as.vector(colSums(z11$counts))


par(mfrow=c(2,1))
barplot(colSums(z$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z$counts)[rowSums(z$counts) > 400000], decreasing=T)
#GPKOW__6__4_Pool10       SLC8A3__sherwood_1u__2_Pool12                  INPP5K__5__4_Pool6 XDH__shERWOOD__1U__Sensor__2_Pool11
#           1049678                              520727                              425936                              423560


# Pool content table
z_plot <- data.table(z$counts)
setcolorder(z_plot, c("t0_no_Pool5_1", "t0_no_Pool5_2", "t0_no_Pool5_3", "t15_DMSO_Pool5_1", "t15_DMSO_Pool5_2", "t15_DMSO_Pool5_3", "t15_PDS_Pool5_1", "t15_PDS_Pool5_2", "t15_PDS_Pool5_3", "t15_PhenDC3_Pool5_1", "t15_PhenDC3_Pool5_2", "t15_PhenDC3_Pool5_3", "t0_no_Pool10_1", "t0_no_Pool10_2", "t0_no_Pool10_3", "t15_DMSO_Pool10_1", "t15_DMSO_Pool10_2", "t15_DMSO_Pool10_3", "t15_PDS_Pool10_1", "t15_PDS_Pool10_2", "t15_PDS_Pool10_3", "t15_PhenDC3_Pool10_1", "t15_PhenDC3_Pool10_2", "t15_PhenDC3_Pool10_3", "t0_no_Pool3_2", "t0_no_Pool3_3", "t15_PhenDC3_Pool3_1", "t15_PhenDC3_Pool3_3", "t0_no_Pool4_1", "t0_no_Pool4_2", "t15_DMSO_Pool11_3"))
z_plot[, pool := as.numeric(sapply(rownames(z), function(x) gsub("Pool", "", tail(unlist(strsplit(x, "_")), n=1))))]

z_plot_pcts <- z_plot[, .(t0_no_Pool5_1 = 100*sum(t0_no_Pool5_1)/sum(z_plot[, t0_no_Pool5_1]),
t0_no_Pool5_2 = 100*sum(t0_no_Pool5_2)/sum(z_plot[, t0_no_Pool5_2]),
t0_no_Pool5_3 = 100*sum(t0_no_Pool5_3)/sum(z_plot[, t0_no_Pool5_3]),
t15_DMSO_Pool5_1 = 100*sum(t15_DMSO_Pool5_1)/sum(z_plot[, t15_DMSO_Pool5_1]),
t15_DMSO_Pool5_2 = 100*sum(t15_DMSO_Pool5_2)/sum(z_plot[, t15_DMSO_Pool5_2]),
t15_DMSO_Pool5_3 = 100*sum(t15_DMSO_Pool5_3)/sum(z_plot[, t15_DMSO_Pool5_3]),
t15_PDS_Pool5_1 = 100*sum(t15_PDS_Pool5_1)/sum(z_plot[, t15_PDS_Pool5_1]),
t15_PDS_Pool5_2 = 100*sum(t15_PDS_Pool5_2)/sum(z_plot[, t15_PDS_Pool5_2]),
t15_PDS_Pool5_3 = 100*sum(t15_PDS_Pool5_3)/sum(z_plot[, t15_PDS_Pool5_3]),
t15_PhenDC3_Pool5_1 = 100*sum(t15_PhenDC3_Pool5_1)/sum(z_plot[, t15_PhenDC3_Pool5_1]),
t15_PhenDC3_Pool5_2 = 100*sum(t15_PhenDC3_Pool5_2)/sum(z_plot[, t15_PhenDC3_Pool5_2]),
t15_PhenDC3_Pool5_3 = 100*sum(t15_PhenDC3_Pool5_3)/sum(z_plot[, t15_PhenDC3_Pool5_3]),
t0_no_Pool10_1 = 100*sum(t0_no_Pool10_1)/sum(z_plot[, t0_no_Pool10_1]),
t0_no_Pool10_2 = 100*sum(t0_no_Pool10_2)/sum(z_plot[, t0_no_Pool10_2]),
t0_no_Pool10_3 = 100*sum(t0_no_Pool10_3)/sum(z_plot[, t0_no_Pool10_3]),
t15_DMSO_Pool10_1 = 100*sum(t15_DMSO_Pool10_1)/sum(z_plot[, t15_DMSO_Pool10_1]),
t15_DMSO_Pool10_2 = 100*sum(t15_DMSO_Pool10_2)/sum(z_plot[, t15_DMSO_Pool10_2]),
t15_DMSO_Pool10_3 = 100*sum(t15_DMSO_Pool10_3)/sum(z_plot[, t15_DMSO_Pool10_3]),
t15_PDS_Pool10_1 = 100*sum(t15_PDS_Pool10_1)/sum(z_plot[, t15_PDS_Pool10_1]),
t15_PDS_Pool10_2 = 100*sum(t15_PDS_Pool10_2)/sum(z_plot[, t15_PDS_Pool10_2]),
t15_PDS_Pool10_3 = 100*sum(t15_PDS_Pool10_3)/sum(z_plot[, t15_PDS_Pool10_3]),
t15_PhenDC3_Pool10_1 = 100*sum(t15_PhenDC3_Pool10_1)/sum(z_plot[, t15_PhenDC3_Pool10_1]),
t15_PhenDC3_Pool10_2 = 100*sum(t15_PhenDC3_Pool10_2)/sum(z_plot[, t15_PhenDC3_Pool10_2]),
t15_PhenDC3_Pool10_3 = 100*sum(t15_PhenDC3_Pool10_3)/sum(z_plot[, t15_PhenDC3_Pool10_3]),
t0_no_Pool3_2 = 100*sum(t0_no_Pool3_2)/sum(z_plot[, t0_no_Pool3_2]),
t0_no_Pool3_3 = 100*sum(t0_no_Pool3_3)/sum(z_plot[, t0_no_Pool3_3]),
t15_PhenDC3_Pool3_1 = 100*sum(t15_PhenDC3_Pool3_1)/sum(z_plot[, t15_PhenDC3_Pool3_1]),
t15_PhenDC3_Pool3_3 = 100*sum(t15_PhenDC3_Pool3_3)/sum(z_plot[, t15_PhenDC3_Pool3_3]),
t0_no_Pool4_1 = 100*sum(t0_no_Pool4_1)/sum(z_plot[, t0_no_Pool4_1]),
t0_no_Pool4_2 = 100*sum(t0_no_Pool4_2)/sum(z_plot[, t0_no_Pool4_2]),
t15_DMSO_Pool11_3 = 100*sum(t15_DMSO_Pool11_3)/sum(z_plot[, t15_DMSO_Pool11_3])),
keyby = pool]

write.table(z_plot_pcts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool5_Pool10_Pool3_Pool4_Pool11_library_content_table.txt", quote = FALSE, sep = "\t", row.names = FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool5_Pool10_Pool3_Pool4_Pool11_library_content_table.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161109/tables/")


# Pool content plot
z_plot_pcts_melt <- melt(z_plot_pcts, id = "pool", variable.name = "library", value.name = "pct")

gg <- ggplot(z_plot_pcts_melt[order(-pool)], aes(x = library, y = pct, fill = factor(pool))) +
geom_bar(stat="identity") +
xlab("") +
ylab("% Reads") +
theme_classic() +
scale_fill_discrete(name="Pool") +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_text(size = 16)) +
scale_x_discrete(labels = paste(paste(colnames(z_plot)[1:31], "(n =", as.character(colSums(z_plot)[1:31])), ")", sep=""))

ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161109_Pool5_Pool10_Pool3_Pool4_Pool11_library_content_plot.pdf", width = 16/2.54, height = 16/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161109_Pool5_Pool10_Pool3_Pool4_Pool11_library_content_plot.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161109/figures/")

# All Pool5 and Pool10 will be added to the previous 20160629
# t0_no_Pool3_2 will be added to 20160902 t0_no_Pool3_2
# t0_no_Pool3_3 will substitute the 20160902 t0_no_Pool3_3
# t15_PhenDC3_Pool3_1 will be added to 20160902 t15_PhenDC3_Pool3_1 - perhaps still low ?
# t15_PhenDC3_Pool3_3 will be added to 20160902 t15_PhenDC3_Pool3_3 - perhaps still low ?
# t0_no_Pool4_1 will be added to 20160902 t0_no_Pool4_1
# t0_no_Pool4_2 will be added to 20160902 t0_no_Pool4_2
# t15_DMSO_Pool11_3 will be added to 20161018 t15_DMSO_Pool11_3


# Write raw counts to tables (Pools 5, 10, 3, 4 and 11)
write.table(z5$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool5_counts.txt", quote = FALSE, sep = "\t")
write.table(z10$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool10_counts.txt", quote = FALSE, sep = "\t")
write.table(z3$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool3_counts.txt", quote = FALSE, sep = "\t")
write.table(z4$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool4_counts.txt", quote = FALSE, sep = "\t")
write.table(z11$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool11_counts.txt", quote = FALSE, sep = "\t")

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool5_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161109/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool10_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161109/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool3_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161109/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool4_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161109/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161109_Pool11_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161109/tables/")


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z5$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z5$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z5$counts)[rowSums(z5$counts) > 200000], decreasing=T)
#UGT2B10__sherwood__3__2_Pool5
#                       218757

par(mfrow=c(2,1))
barplot(colSums(z10$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z10$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z10$counts)[rowSums(z10$counts) > 1000000], decreasing=T)
#GPKOW__6__4_Pool10
#           1027835

par(mfrow=c(2,1))
barplot(colSums(z3$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z3$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z3$counts)[rowSums(z3$counts) > 40000], decreasing=T)
#SGK3__sherwood__2__2_Pool3 C8orf44-SGK3__sherwood__2__2_Pool3
#                     42677                              42308

par(mfrow=c(2,1))
barplot(colSums(z4$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z4$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z4$counts)[rowSums(z4$counts) > 150000], decreasing=T)
#FOPNL__sensor__1_Pool4
#                154606

par(mfrow=c(2,1))
barplot(colSums(z11$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z11$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z11$counts)[rowSums(z11$counts) > 25000], decreasing=T)
#TIPARP__sensor__2_Pool11 PDIK1L__sherwood_1u__7_Pool11
#                   26222                         25088

```


# Comparing distributions

```R
library(data.table)
library(edgeR)

options(width = 250)

###############################################
# t15_PhenDC3_Pool3_1 and t15_PhenDC3_Pool3_3 #
###############################################

# t15_PhenDC3_Pool3_1 (20160920) vs. t15_PhenDC3_Pool3_2 (20160920)
# t15_PhenDC3_Pool3_3 (20160920) vs. t15_PhenDC3_Pool3_2 (20160920)

data3 <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161019/20160908_Pool3_counts_lims.txt")

z3 <- DGEList(counts = data3)

z3_phendc3 <- z3[, grepl("PhenDC3", colnames(z3))]

data.table(z3_phendc3$counts)

data.table(cpm(z3_phendc3))

data.table(z3_phendc3$counts)[t15_PhenDC3_Pool3_1 == 0 & t15_PhenDC3_Pool3_2 == 0 & t15_PhenDC3_Pool3_3 == 0]

plotMDS(z3[, grepl("PhenDC3", colnames(z3))|grepl("DMSO", colnames(z3))]) # PhenDC3_1 and PhenDC3_3 actually group with DMSO_2, PhenDC3_2 sits apart
plotMDS(z3[, grepl("PhenDC3", colnames(z3))|grepl("PDS", colnames(z3))]) # PhenDC3_1 and PhenDC3_3 overlap, the rest sit apart
plotMDS(z3[, grepl("PhenDC3", colnames(z3))|grepl("t0", colnames(z3))]) # nice split
plotMDS(z3) # PhenDC3_1 and PhenDC3_3 group with PDS_3 and DMSO_3


# t15_PhenDC3_Pool3_1 (20160920) vs. t15_PhenDC3_Pool3_1 (20161109)
# t15_PhenDC3_Pool3_3 (20160920) vs. t15_PhenDC3_Pool3_3 (20161109)

data3_2 <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161110/20161109_Pool3_counts.txt")

z3_phendc3_2 <- DGEList(counts = data3_2)

l_PhenDC3_Pool3_1 <- data.table(z3_phendc3$counts, keep.rownames=TRUE)[t15_PhenDC3_Pool3_1 != 0]$rn
l_PhenDC3_Pool3_1_2 <- data.table(z3_phendc3_2$counts, keep.rownames=TRUE)[t15_PhenDC3_Pool3_1 != 0]$rn

length(l_PhenDC3_Pool3_1) # 9363
length(l_PhenDC3_Pool3_1_2) # 8836

length(intersect(l_PhenDC3_Pool3_1, l_PhenDC3_Pool3_1_2)) # 8778

setdiff(l_PhenDC3_Pool3_1, l_PhenDC3_Pool3_1_2)
setdiff(l_PhenDC3_Pool3_1_2, l_PhenDC3_Pool3_1)


l_PhenDC3_Pool3_3 <- data.table(z3_phendc3$counts, keep.rownames=TRUE)[t15_PhenDC3_Pool3_3 != 0]$rn
l_PhenDC3_Pool3_3_2 <- data.table(z3_phendc3_2$counts, keep.rownames=TRUE)[t15_PhenDC3_Pool3_3 != 0]$rn

length(l_PhenDC3_Pool3_3) # 9367
length(l_PhenDC3_Pool3_3_2) # 8605

length(intersect(l_PhenDC3_Pool3_3, l_PhenDC3_Pool3_3_2)) # 8566

setdiff(l_PhenDC3_Pool3_3, l_PhenDC3_Pool3_3_2)
setdiff(l_PhenDC3_Pool3_3_2, l_PhenDC3_Pool3_3)


# altogether

tmp <- merge(data.table(z3_phendc3[, c("t15_PhenDC3_Pool3_1", "t15_PhenDC3_Pool3_3")]$counts, keep.rownames=TRUE), data.table(z3_phendc3_2[, c("t15_PhenDC3_Pool3_1", "t15_PhenDC3_Pool3_3")]$counts, keep.rownames=TRUE), by="rn", suffixes = c(".before", ".rerun") )
tmp <- data.frame(tmp)
tmp2 <- tmp[2:5]
rownames(tmp2) <- tmp$rn

z3_phendc3_merge <- DGEList(counts = tmp2)

head(cpm(z3_phendc3_merge), n = 40) # they look similar


tmp <- merge(data.table(z3$counts, keep.rownames=TRUE), data.table(z3_phendc3_2[, c("t15_PhenDC3_Pool3_1", "t15_PhenDC3_Pool3_3")]$counts, keep.rownames=TRUE), by="rn", suffixes = c(".before", ".rerun") )
tmp <- data.frame(tmp)
tmp2 <- tmp[2:15]
rownames(tmp2) <- tmp$rn

z3_phendc3_merge <- DGEList(counts = tmp2)

plotMDS(z3_phendc3_merge) # PhenDC3_1.before and PhenDC3_3.before group with PDS, PhenDC3_1.rerun and PhenDC3_3.rerun sit apart # adding them might help separating PhenDC3_1 and PhenDC3_3 from PDS
plotMDS(z3)

#####################
# t15_DMSO_Pool11_3 #
#####################

# t15_DMSO_Pool11_3 (20161018) vs. t15_DMSO_Pool11_1 (20161018)
# t15_DMSO_Pool11_3 (20161018) vs. t15_DMSO_Pool11_2 (20161018)

data11_before <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161019/20161018_Pool11_counts.txt")

z11_before <- DGEList(counts = data11_before)

z11_dmso_before <- z11_before[, grepl("DMSO", colnames(z11_before))]

data.table(z11_dmso_before$counts)

head(data.table(cpm(z11_dmso_before)), n=40)

plotMDS(z11_before[, grepl("DMSO", colnames(z11_before))|grepl("t0", colnames(z11_before))]) # nice split
plotMDS(z11_before[, grepl("DMSO", colnames(z11_before))|grepl("PDS", colnames(z11_before))]) # t15_DMSO_Pool11_3 is close to t15_PDS_Pool11_3 so they group by replicate id too
plotMDS(z11_before[, grepl("DMSO", colnames(z11_before))|grepl("PhenDC3", colnames(z11_before))]) # nice split
plotMDS(z11_before)

# t15_DMSO_Pool11_3 (20161018) vs. t15_DMSO_Pool11_3 (20161109)

data11_rerun <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161110/20161109_Pool11_counts.txt")

z11_dmso_rerun <- DGEList(counts = data11_rerun)

l_dmso_Pool11_3_before <- data.table(z11_dmso_before$counts, keep.rownames=TRUE)[t15_DMSO_Pool11_3 != 0]$rn
l_dmso_Pool11_3_rerun <- data.table(z11_dmso_rerun$counts, keep.rownames=TRUE)[t15_DMSO_Pool11_3 != 0]$rn

length(l_dmso_Pool11_3_before) # 7750
length(l_dmso_Pool11_3_rerun) # 7942

length(intersect(l_dmso_Pool11_3_before, l_dmso_Pool11_3_rerun)) # 7743

setdiff(l_dmso_Pool11_3_before, l_dmso_Pool11_3_rerun)
setdiff(l_dmso_Pool11_3_rerun, l_dmso_Pool11_3_before)


# altogether

tmp <- merge(data.table(z11_dmso_before[, c("t15_DMSO_Pool11_3")]$counts, keep.rownames=TRUE), data.table(z11_dmso_rerun[, c("t15_DMSO_Pool11_3")]$counts, keep.rownames=TRUE), by="rn", suffixes = c(".before", ".rerun") )
tmp <- data.frame(tmp)
tmp2 <- tmp[2:3]
rownames(tmp2) <- tmp$rn

z11_dmso_merge <- DGEList(counts = tmp2)

head(cpm(z11_dmso_merge), n = 40) # they look even more similar than t15_PhenDC3_Pool3 above


tmp <- merge(data.table(z11_before$counts, keep.rownames=TRUE), data.table(z11_dmso_rerun[, c("t15_DMSO_Pool11_3")]$counts, keep.rownames=TRUE), by="rn", suffixes = c(".before", ".rerun") )
tmp <- data.frame(tmp)
tmp2 <- tmp[2:14]
rownames(tmp2) <- tmp$rn

z11_dmso_merge <- DGEList(counts = tmp2)

plotMDS(z11_dmso_merge) # t15_DMSO_Pool11_3.rerun groups with t0_no_Pool11_3
plotMDS(z11_before)


#####################
# t15_DMSO_Pool12_2 #
#####################

# t15_DMSO_Pool12_2 (20161018) vs. t15_DMSO_Pool12_1 (20161018)
# t15_DMSO_Pool12_2 (20161018) vs. t15_DMSO_Pool12_3 (20161018)

data12_before <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161019/20161018_Pool12_counts.txt")

z12_before <- DGEList(counts = data12_before)

z12_dmso_before <- z12_before[, grepl("DMSO", colnames(z12_before))]

data.table(z12_dmso_before$counts)

head(data.table(cpm(z12_dmso_before)), n=40)

plotMDS(z12_before[, grepl("DMSO", colnames(z12_before))|grepl("t0", colnames(z12_before))]) # nice split
plotMDS(z12_before[, grepl("DMSO", colnames(z12_before))|grepl("PDS", colnames(z12_before))]) # t15_DMSO_Pool12_2 is close to t15_PDS_Pool12_2 so they group by replicate id too
plotMDS(z12_before[, grepl("DMSO", colnames(z12_before))|grepl("PhenDC3", colnames(z12_before))]) # nice split
plotMDS(z12_before)


# t15_DMSO_Pool12_2 (20161018) vs. t15_DMSO_Pool12_2 (20161108)

data12_rerun <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161110/20161108_Pool12_counts.txt")

z12_dmso_rerun <- DGEList(counts = data12_rerun)

l_dmso_Pool12_2_before <- data.table(z12_dmso_before$counts, keep.rownames=TRUE)[t15_DMSO_Pool12_2 != 0]$rn
l_dmso_Pool12_2_rerun <- data.table(z12_dmso_rerun$counts, keep.rownames=TRUE)[t15_DMSO_Pool12_2 != 0]$rn

length(l_dmso_Pool12_2_before) # 9486
length(l_dmso_Pool12_2_rerun) # 9559

length(intersect(l_dmso_Pool12_2_before, l_dmso_Pool12_2_rerun)) # 9482

setdiff(l_dmso_Pool12_2_before, l_dmso_Pool12_2_rerun)
setdiff(l_dmso_Pool12_2_rerun, l_dmso_Pool12_2_before)


tmp <- merge(data.table(z12_dmso_before[, c("t15_DMSO_Pool12_2")]$counts, keep.rownames=TRUE), data.table(z12_dmso_rerun[, c("t15_DMSO_Pool12_2")]$counts, keep.rownames=TRUE), by="rn", suffixes = c(".before", ".rerun") )
tmp <- data.frame(tmp)
tmp2 <- tmp[2:3]
rownames(tmp2) <- tmp$rn

z12_dmso_merge <- DGEList(counts = tmp2)

head(cpm(z12_dmso_merge), n = 40) # they also look even more similar than t15_PhenDC3_Pool3 above


tmp <- merge(data.table(z12_before$counts, keep.rownames=TRUE), data.table(z12_dmso_rerun[, c("t15_DMSO_Pool12_2")]$counts, keep.rownames=TRUE), by="rn", suffixes = c(".before", ".rerun") )
tmp <- data.frame(tmp)
tmp2 <- tmp[2:14]
rownames(tmp2) <- tmp$rn

z12_dmso_merge <- DGEList(counts = tmp2)

plotMDS(z12_dmso_merge) # t15_DMSO_Pool11_3.rerun groups with t0_no_Pool11_3
plotMDS(z12_before)


# t15_PDS_Pool10_3 (20160629) vs. t15_PDS_Pool10_1 (20160629)
# t15_PDS_Pool10_3 (20160629) vs. t15_PDS_Pool10_2 (20160629)
# t15_PDS_Pool10_3 (20160629) vs. t15_PDS_Pool10_3 (20161109) : contaminations look similar
# t15_PDS_Pool10_3 (20160629) vs. t15_PDS_Pool10_3 (20161108) : contaminations look different


# t15_PhenDC3_Pool10_1 (20160629) vs. t15_PhenDC3_Pool10_2 (20160629)
# t15_PhenDC3_Pool10_1 (20160629) vs. t15_PhenDC3_Pool10_3 (20160629)
# t15_PhenDC3_Pool10_1 (20160629) vs. t15_PhenDC3_Pool10_1 (20161109) : contaminations look similar
# t15_PhenDC3_Pool10_1 (20160629) vs. t15_PhenDC3_Pool10_1 (20161108) : contaminations look different


```
