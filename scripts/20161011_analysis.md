
# Analysis of count table (Pools 8 and 9)

```R
library(edgeR)
library(data.table)
library(ggplot2)
library(VennDiagram)
library(reshape)


# Enlarge the view width when printing tables
options(width = 300)


# Load table of counts into edgeR
data <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161011/20161011_counts.txt", header = T)
dim(data) #  53643    25


# Add first column to rownames
rownames(data) <- data[,1]
data <- data[2:25]
dim(data) # 53643    24


# Change to a DGE object
z <- DGEList(counts=data)


# How many counts are of each Pool?
reads_total <- sum(z$counts) # 243060977
reads_total_pool8 <- sum(z[,grepl("pool_8", colnames(z$counts))]$counts) # 130059947
reads_total_pool9 <- sum(z[,grepl("pool_9", colnames(z$counts))]$counts) # 113001030
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts)
  reads_pool_pct <- round(100*reads_pool/reads_total, 2)
  reads_pool_pool8 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool_8", colnames(z$counts))]$counts)
  reads_pool_pct_pool8 <- round(100*reads_pool_pool8/reads_total_pool8, 2)
  reads_pool_pool9 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool_9", colnames(z$counts))]$counts)
  reads_pool_pct_pool9 <- round(100*reads_pool_pool9/reads_total_pool9, 2)
  hps_pool <- length(rowSums(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts))
  print(sprintf("%s   %s   %s   %s   %s   %s   %s   %s", p, reads_pool, reads_pool_pct, reads_pool_pool8, reads_pool_pct_pool8, reads_pool_pool9, reads_pool_pct_pool9, hps_pool))
}

#[1] "Pool1   214632   0.09   133515   0.1   81117   0.07   2861"
#[1] "Pool2   110628   0.05   87215   0.07   23413   0.02   3751"
#[1] "Pool3   1439282   0.59   815506   0.63   623776   0.55   8706"
#[1] "Pool4   8742694   3.6   4908700   3.77   3833994   3.39   7662"
#[1] "Pool5   500446   0.21   164732   0.13   335714   0.3   1974"
#[1] "Pool6   50922   0.02   14225   0.01   36697   0.03   3524"
#[1] "Pool7   911874   0.38   447996   0.34   463878   0.41   2919"
#[1] "Pool8   121823940   50.12   121181066   93.17   642874   0.57   9581"
#[1] "Pool9   105516190   43.41   716524   0.55   104799666   92.74   9158"
#[1] "Pool10   1231998   0.51   605649   0.47   626349   0.55   1969"
#[1] "Pool11   1196018   0.49   404247   0.31   791771   0.7   663"
#[1] "Pool12   1322353   0.54   580572   0.45   741781   0.66   875"


# It looks good. There is just a bit of Pool4 (4%), but overall looks good.


# Change column labels z$counts, change row labels z$samples, add group to z$samples, add Replicate to z$samples
treatments <- c(rep("no", 6), rep("DMSO", 6), rep("PDS", 6), rep("PhenDC3", 6))
timepoints <- c(rep("t0", 6), rep("t15", 18))
pools <- rep(c(rep("Pool8", 3), rep("Pool9", 3)), 4)
replicates <- rep(c("1", "2", "3"), 8)

colnames(z$counts) <- paste(timepoints, treatments, pools, replicates, sep="_")
rownames(z$samples) <- paste(timepoints, treatments, pools, replicates, sep="_")
z$samples$group <- paste(timepoints, treatments, pools, sep="_")
z$samples$Replicate <- replicates


# Select Pools 8 and 9 as z8 and z9, and redefine z8$samples$lib.size and z9$samples$lib.size
z8 <- z[grepl("Pool8$", rownames(z$counts)), grepl("Pool8", colnames(z$counts))]
z8$samples$lib.size <- as.vector(colSums(z8$counts))
z9 <- z[grepl("Pool9$", rownames(z$counts)), grepl("Pool9", colnames(z$counts))]
z9$samples$lib.size <- as.vector(colSums(z9$counts))

par(mfrow=c(2,1))
barplot(colSums(z$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z$counts)[rowSums(z$counts) > 350000], decreasing=T)
#BRIP1__6__4_Pool9
#           355803


# Pool content table
z_plot <- data.table(z$counts)
setcolorder(z_plot, c("t0_no_Pool8_1", "t0_no_Pool8_2", "t0_no_Pool8_3", "t15_DMSO_Pool8_1", "t15_DMSO_Pool8_2", "t15_DMSO_Pool8_3", "t15_PDS_Pool8_1", "t15_PDS_Pool8_2", "t15_PDS_Pool8_3", "t15_PhenDC3_Pool8_1", "t15_PhenDC3_Pool8_2", "t15_PhenDC3_Pool8_3", "t0_no_Pool9_1", "t0_no_Pool9_2", "t0_no_Pool9_3", "t15_DMSO_Pool9_1", "t15_DMSO_Pool9_2", "t15_DMSO_Pool9_3", "t15_PDS_Pool9_1", "t15_PDS_Pool9_2", "t15_PDS_Pool9_3", "t15_PhenDC3_Pool9_1", "t15_PhenDC3_Pool9_2", "t15_PhenDC3_Pool9_3"))
z_plot[, pool := as.numeric(sapply(rownames(z), function(x) gsub("Pool", "", tail(unlist(strsplit(x, "_")), n=1))))]

z_plot_pcts <- z_plot[, .(t0_no_Pool8_1 = 100*sum(t0_no_Pool8_1)/sum(z_plot[, t0_no_Pool8_1]),
t0_no_Pool8_2 = 100*sum(t0_no_Pool8_2)/sum(z_plot[, t0_no_Pool8_2]),
t0_no_Pool8_3 = 100*sum(t0_no_Pool8_3)/sum(z_plot[, t0_no_Pool8_3]),
t15_DMSO_Pool8_1 = 100*sum(t15_DMSO_Pool8_1)/sum(z_plot[, t15_DMSO_Pool8_1]),
t15_DMSO_Pool8_2 = 100*sum(t15_DMSO_Pool8_2)/sum(z_plot[, t15_DMSO_Pool8_2]),
t15_DMSO_Pool8_3 = 100*sum(t15_DMSO_Pool8_3)/sum(z_plot[, t15_DMSO_Pool8_3]),
t15_PDS_Pool8_1 = 100*sum(t15_PDS_Pool8_1)/sum(z_plot[, t15_PDS_Pool8_1]),
t15_PDS_Pool8_2 = 100*sum(t15_PDS_Pool8_2)/sum(z_plot[, t15_PDS_Pool8_2]),
t15_PDS_Pool8_3 = 100*sum(t15_PDS_Pool8_3)/sum(z_plot[, t15_PDS_Pool8_3]),
t15_PhenDC3_Pool8_1 = 100*sum(t15_PhenDC3_Pool8_1)/sum(z_plot[, t15_PhenDC3_Pool8_1]),
t15_PhenDC3_Pool8_2 = 100*sum(t15_PhenDC3_Pool8_2)/sum(z_plot[, t15_PhenDC3_Pool8_2]),
t15_PhenDC3_Pool8_3 = 100*sum(t15_PhenDC3_Pool8_3)/sum(z_plot[, t15_PhenDC3_Pool8_3]),
t0_no_Pool9_1 = 100*sum(t0_no_Pool9_1)/sum(z_plot[, t0_no_Pool9_1]),
t0_no_Pool9_2 = 100*sum(t0_no_Pool9_2)/sum(z_plot[, t0_no_Pool9_2]),
t0_no_Pool9_3 = 100*sum(t0_no_Pool9_3)/sum(z_plot[, t0_no_Pool9_3]),
t15_DMSO_Pool9_1 = 100*sum(t15_DMSO_Pool9_1)/sum(z_plot[, t15_DMSO_Pool9_1]),
t15_DMSO_Pool9_2 = 100*sum(t15_DMSO_Pool9_2)/sum(z_plot[, t15_DMSO_Pool9_2]),
t15_DMSO_Pool9_3 = 100*sum(t15_DMSO_Pool9_3)/sum(z_plot[, t15_DMSO_Pool9_3]),
t15_PDS_Pool9_1 = 100*sum(t15_PDS_Pool9_1)/sum(z_plot[, t15_PDS_Pool9_1]),
t15_PDS_Pool9_2 = 100*sum(t15_PDS_Pool9_2)/sum(z_plot[, t15_PDS_Pool9_2]),
t15_PDS_Pool9_3 = 100*sum(t15_PDS_Pool9_3)/sum(z_plot[, t15_PDS_Pool9_3]),
t15_PhenDC3_Pool9_1 = 100*sum(t15_PhenDC3_Pool9_1)/sum(z_plot[, t15_PhenDC3_Pool9_1]),
t15_PhenDC3_Pool9_2 = 100*sum(t15_PhenDC3_Pool9_2)/sum(z_plot[, t15_PhenDC3_Pool9_2]),
t15_PhenDC3_Pool9_3 = 100*sum(t15_PhenDC3_Pool9_3)/sum(z_plot[, t15_PhenDC3_Pool9_3])),
keyby = pool]

write.table(z_plot_pcts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_Pool9_library_content_table.txt", quote = FALSE, sep = "\t", row.names = FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_Pool9_library_content_table.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")


# Pool content plot
z_plot_pcts_melt <- melt(z_plot_pcts, id = "pool", variable.name = "library", value.name = "pct")

gg <- ggplot(z_plot_pcts_melt[order(-pool)], aes(x = library, y = pct, fill = factor(pool))) +
geom_bar(stat="identity") +
xlab("") +
ylab("% Reads") +
theme_classic() +
scale_fill_discrete(name="Pool") +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_text(size = 16)) +
scale_x_discrete(labels = paste(paste(colnames(z_plot)[1:24], "(n =", as.character(colSums(z_plot)[1:24])), ")", sep=""))

ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_Pool9_library_content_plot.pdf", width = 16/2.54, height = 16/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_Pool9_library_content_plot.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures/")


# Write raw counts to table (Pools 8 and 9)
write.table(z8$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_counts.txt", quote = FALSE, sep = "\t")
write.table(z9$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_counts.txt", quote = FALSE, sep = "\t")

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z8$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z8$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z8$counts)[rowSums(z8$counts) > 150000], decreasing=T)
#LEPROTL1__1__1_Pool8   TXNL4B__4__4_Pool8  RUNDC3B__3__3_Pool8
#              190520               183478               152109


par(mfrow=c(2,1))
barplot(colSums(z9$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z9$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z9$counts)[rowSums(z9$counts) > 300000], decreasing=T)
#BRIP1__6__4_Pool9 SPATA4__2__2_Pool9
#           355711             308319


# Make MDS plots to visualise relationships between replicate samples

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z8, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("topleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures")

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z9, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("topleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures")


# The effects of drug treament in pools 8 and 9 are stronger than in previous pools, see grouping by drug rather than replicate (as observed in previous pools).


######
# z8 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z8$samples)
colnames(des) <- levels(factor(z8$samples$group))
des


# Estimate dispersions
z8_glm <- estimateDisp(z8, des)
sqrt(z8_glm$common.disp) # 0.3260522


# Plot BCVs versus abundance
plotBCV(z8_glm)


# Fit negative bionomial GLM
z8_fit <- glmFit(z8_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool8 - t0_no_Pool8,
t15_PDSvst0_no = t15_PDS_Pool8 - t0_no_Pool8,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool8 - t0_no_Pool8,
t15_PDSvst15_DMSO = t15_PDS_Pool8 - t15_DMSO_Pool8,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool8 - t15_DMSO_Pool8,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool8 - t15_PDS_Pool8,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z8_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z8_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z8_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z8_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z8_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z8_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 3324

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 2162

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 2991

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 2147

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 3810

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 3295


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z8_t15_PDSvst0_no_cpm <- data.table(cpm(z8)[, grepl("t15_PDS|t0_no", colnames(cpm(z8)))], keep.rownames=TRUE)
z8_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool8_1) + log2(t0_no_Pool8_2) + log2(t0_no_Pool8_3))/3]
z8_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z8_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z8_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z8_t15_PDSvst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z8_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z8)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z8)))], keep.rownames=TRUE)
z8_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool8_1) + log2(t0_no_Pool8_2) + log2(t0_no_Pool8_3))/3]
z8_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z8_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z8_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z8_t15_PhenDC3vst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 1274
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 1317
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 1088

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool8_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
g <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z8$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool8_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures/")




######
# z9 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z9$samples)
colnames(des) <- levels(factor(z9$samples$group))
des


# Estimate dispersions
z9_glm <- estimateDisp(z9, des)
sqrt(z9_glm$common.disp) # 0.3819086


# Plot BCVs versus abundance
plotBCV(z9_glm)


# Fit negative bionomial GLM
z9_fit <- glmFit(z9_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool9 - t0_no_Pool9,
t15_PDSvst0_no = t15_PDS_Pool9 - t0_no_Pool9,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool9 - t0_no_Pool9,
t15_PDSvst15_DMSO = t15_PDS_Pool9 - t15_DMSO_Pool9,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool9 - t15_DMSO_Pool9,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool9 - t15_PDS_Pool9,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z9_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z9_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z9_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z9_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z9_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z9_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 1245

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 1974

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 2869

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 599

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 3466

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 2833


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z9_t15_PDSvst0_no_cpm <- data.table(cpm(z9)[, grepl("t15_PDS|t0_no", colnames(cpm(z9)))], keep.rownames=TRUE)
z9_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool9_1) + log2(t0_no_Pool9_2) + log2(t0_no_Pool9_3))/3]
z9_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z9_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z9_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z9_t15_PDSvst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z9_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z9)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z9)))], keep.rownames=TRUE)
z9_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool9_1) + log2(t0_no_Pool9_2) + log2(t0_no_Pool9_3))/3]
z9_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z9_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z9_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z9_t15_PhenDC3vst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 791
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 658
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 1020

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161011_Pool9_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
g <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z9$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161011_Pool9_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161011/figures/")


```




# Analysis of count table (Pools 11 and 12)

```R
library(edgeR)
library(data.table)
library(ggplot2)
library(VennDiagram)
library(reshape)


# Enlarge the view width when printing tables
options(width = 300)


# Load table of counts into edgeR
data <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20161018/20161018_counts.txt", header = T)
dim(data) # 77314    25


# Add first column to rownames
rownames(data) <- data[,1]
data <- data[2:25]
dim(data) # 77314    24


# Change to a DGE object
z <- DGEList(counts=data)


# How many counts are of each Pool?
reads_total <- sum(z$counts) # 259645248
reads_total_pool11 <- sum(z[,grepl("pool_11", colnames(z$counts))]$counts) # 124852213
reads_total_pool12 <- sum(z[,grepl("pool_12", colnames(z$counts))]$counts) # 134793035
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts)
  reads_pool_pct <- round(100*reads_pool/reads_total, 2)
  reads_pool_pool11 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool_11", colnames(z$counts))]$counts)
  reads_pool_pct_pool11 <- round(100*reads_pool_pool11/reads_total_pool11, 2)
  reads_pool_pool12 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool_12", colnames(z$counts))]$counts)
  reads_pool_pct_pool12 <- round(100*reads_pool_pool12/reads_total_pool12, 2)
  hps_pool <- length(rowSums(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts))
  print(sprintf("%s   %s   %s   %s   %s   %s   %s   %s", p, reads_pool, reads_pool_pct, reads_pool_pool11, reads_pool_pct_pool11, reads_pool_pool12, reads_pool_pct_pool12, hps_pool))
}

#[1] "Pool1   52098   0.02   27991   0.02   24107   0.02   1220"
#[1] "Pool2   499085   0.19   362224   0.29   136861   0.1   2540"
#[1] "Pool3   444767   0.17   188169   0.15   256598   0.19   7476"
#[1] "Pool4   1355469   0.52   815406   0.65   540063   0.4   6602"
#[1] "Pool5   119978   0.05   60407   0.05   59571   0.04   7306"
#[1] "Pool6   86615   0.03   33978   0.03   52637   0.04   8047"
#[1] "Pool7   63331   0.02   33397   0.03   29934   0.02   5913"
#[1] "Pool8   8466197   3.26   4716905   3.78   3749292   2.78   9564"
#[1] "Pool9   8134045   3.13   4265829   3.42   3868216   2.87   9034"
#[1] "Pool10   1330733   0.51   1177706   0.94   153027   0.11   2048"
#[1] "Pool11   120914133   46.57   111097070   88.98   9817063   7.28   7979"
#[1] "Pool12   118178797   45.52   2073131   1.66   116105666   86.14   9585"


# It looks good. There is just a bit of Pools 8 and 9 (~3% each), but overall looks good.


# Change column labels z$counts, change row labels z$samples, add group to z$samples, add Replicate to z$samples
treatments <- c(rep("no", 6), rep("DMSO", 6), rep("PDS", 6), rep("PhenDC3", 6))
timepoints <- c(rep("t0", 6), rep("t15", 18))
pools <- rep(c(rep("Pool11", 3), rep("Pool12", 3)), 4)
replicates <- rep(c("1", "2", "3"), 8)

colnames(z$counts) <- paste(timepoints, treatments, pools, replicates, sep="_")
rownames(z$samples) <- paste(timepoints, treatments, pools, replicates, sep="_")
z$samples$group <- paste(timepoints, treatments, pools, sep="_")
z$samples$Replicate <- replicates


# Select Pools 11 and 12 as z11 and z12, and redefine z11$samples$lib.size and z12$samples$lib.size
z11 <- z[grepl("Pool11$", rownames(z$counts)), grepl("Pool11", colnames(z$counts))]
z11$samples$lib.size <- as.vector(colSums(z11$counts))
z12 <- z[grepl("Pool12$", rownames(z$counts)), grepl("Pool12", colnames(z$counts))]
z12$samples$lib.size <- as.vector(colSums(z12$counts))

par(mfrow=c(2,1))
barplot(colSums(z$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z$counts)[rowSums(z$counts) > 500000], decreasing=T)
#TIPARP__sensor__2_Pool11
#                  585404


# Pool content table
z_plot <- data.table(z$counts)
setcolorder(z_plot, c("t0_no_Pool11_1", "t0_no_Pool11_2", "t0_no_Pool11_3", "t15_DMSO_Pool11_1", "t15_DMSO_Pool11_2", "t15_DMSO_Pool11_3", "t15_PDS_Pool11_1", "t15_PDS_Pool11_2", "t15_PDS_Pool11_3", "t15_PhenDC3_Pool11_1", "t15_PhenDC3_Pool11_2", "t15_PhenDC3_Pool11_3", "t0_no_Pool12_1", "t0_no_Pool12_2", "t0_no_Pool12_3", "t15_DMSO_Pool12_1", "t15_DMSO_Pool12_2", "t15_DMSO_Pool12_3", "t15_PDS_Pool12_1", "t15_PDS_Pool12_2", "t15_PDS_Pool12_3", "t15_PhenDC3_Pool12_1", "t15_PhenDC3_Pool12_2", "t15_PhenDC3_Pool12_3"))
z_plot[, pool := as.numeric(sapply(rownames(z), function(x) gsub("Pool", "", tail(unlist(strsplit(x, "_")), n=1))))]

z_plot_pcts <- z_plot[, .(t0_no_Pool11_1 = 100*sum(t0_no_Pool11_1)/sum(z_plot[, t0_no_Pool11_1]),
t0_no_Pool11_2 = 100*sum(t0_no_Pool11_2)/sum(z_plot[, t0_no_Pool11_2]),
t0_no_Pool11_3 = 100*sum(t0_no_Pool11_3)/sum(z_plot[, t0_no_Pool11_3]),
t15_DMSO_Pool11_1 = 100*sum(t15_DMSO_Pool11_1)/sum(z_plot[, t15_DMSO_Pool11_1]),
t15_DMSO_Pool11_2 = 100*sum(t15_DMSO_Pool11_2)/sum(z_plot[, t15_DMSO_Pool11_2]),
t15_DMSO_Pool11_3 = 100*sum(t15_DMSO_Pool11_3)/sum(z_plot[, t15_DMSO_Pool11_3]),
t15_PDS_Pool11_1 = 100*sum(t15_PDS_Pool11_1)/sum(z_plot[, t15_PDS_Pool11_1]),
t15_PDS_Pool11_2 = 100*sum(t15_PDS_Pool11_2)/sum(z_plot[, t15_PDS_Pool11_2]),
t15_PDS_Pool11_3 = 100*sum(t15_PDS_Pool11_3)/sum(z_plot[, t15_PDS_Pool11_3]),
t15_PhenDC3_Pool11_1 = 100*sum(t15_PhenDC3_Pool11_1)/sum(z_plot[, t15_PhenDC3_Pool11_1]),
t15_PhenDC3_Pool11_2 = 100*sum(t15_PhenDC3_Pool11_2)/sum(z_plot[, t15_PhenDC3_Pool11_2]),
t15_PhenDC3_Pool11_3 = 100*sum(t15_PhenDC3_Pool11_3)/sum(z_plot[, t15_PhenDC3_Pool11_3]),
t0_no_Pool12_1 = 100*sum(t0_no_Pool12_1)/sum(z_plot[, t0_no_Pool12_1]),
t0_no_Pool12_2 = 100*sum(t0_no_Pool12_2)/sum(z_plot[, t0_no_Pool12_2]),
t0_no_Pool12_3 = 100*sum(t0_no_Pool12_3)/sum(z_plot[, t0_no_Pool12_3]),
t15_DMSO_Pool12_1 = 100*sum(t15_DMSO_Pool12_1)/sum(z_plot[, t15_DMSO_Pool12_1]),
t15_DMSO_Pool12_2 = 100*sum(t15_DMSO_Pool12_2)/sum(z_plot[, t15_DMSO_Pool12_2]),
t15_DMSO_Pool12_3 = 100*sum(t15_DMSO_Pool12_3)/sum(z_plot[, t15_DMSO_Pool12_3]),
t15_PDS_Pool12_1 = 100*sum(t15_PDS_Pool12_1)/sum(z_plot[, t15_PDS_Pool12_1]),
t15_PDS_Pool12_2 = 100*sum(t15_PDS_Pool12_2)/sum(z_plot[, t15_PDS_Pool12_2]),
t15_PDS_Pool12_3 = 100*sum(t15_PDS_Pool12_3)/sum(z_plot[, t15_PDS_Pool12_3]),
t15_PhenDC3_Pool12_1 = 100*sum(t15_PhenDC3_Pool12_1)/sum(z_plot[, t15_PhenDC3_Pool12_1]),
t15_PhenDC3_Pool12_2 = 100*sum(t15_PhenDC3_Pool12_2)/sum(z_plot[, t15_PhenDC3_Pool12_2]),
t15_PhenDC3_Pool12_3 = 100*sum(t15_PhenDC3_Pool12_3)/sum(z_plot[, t15_PhenDC3_Pool12_3])),
keyby = pool]

write.table(z_plot_pcts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_Pool12_library_content_table.txt", quote = FALSE, sep = "\t", row.names = FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_Pool12_library_content_table.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")


# Pool content plot
z_plot_pcts_melt <- melt(z_plot_pcts, id = "pool", variable.name = "library", value.name = "pct")

gg <- ggplot(z_plot_pcts_melt[order(-pool)], aes(x = library, y = pct, fill = factor(pool))) +
geom_bar(stat="identity") +
xlab("") +
ylab("% Reads") +
theme_classic() +
scale_fill_discrete(name="Pool") +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_text(size = 16)) +
scale_x_discrete(labels = paste(paste(colnames(z_plot)[1:24], "(n =", as.character(colSums(z_plot)[1:24])), ")", sep=""))

ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_Pool12_library_content_plot.pdf", width = 16/2.54, height = 16/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_Pool12_library_content_plot.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures/")

# t15_DMSO_Pool11_3 has a lot of Pool8 and Pool9, t0_no_Pool12_1-3 have a lot of Pool11 and t15_DMSO_Pool12_1-2 have also Pool8 and Pool9 (not as much as t15_DMSO_Pool11_3 though)


# Write raw counts to table (Pools 11 and 12)
write.table(z11$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_counts.txt", quote = FALSE, sep = "\t")
write.table(z12$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_counts.txt", quote = FALSE, sep = "\t")

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z11$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z11$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z11$counts)[rowSums(z11$counts) > 500000], decreasing=T)
#TIPARP__sensor__2_Pool11
#                  527558

par(mfrow=c(2,1))
barplot(colSums(z12$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z12$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z12$counts)[rowSums(z12$counts) > 200000], decreasing=T)
#ZNF713__7__4_Pool12
#             242556


# Make MDS plots to visualise relationships between replicate samples

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z11, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("topleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures")

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z12, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("topleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures")


# As we observed in pools 8 and 9 above, there is stronger grouping by drug/condition rather than by replicate. In particular PDS and DMSO treatments are similar, however PhenDC3 is distinctively different. t0 also sits apart from all t15.


#######
# z11 #
#######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z11$samples)
colnames(des) <- levels(factor(z11$samples$group))
des


# Estimate dispersions
z11_glm <- estimateDisp(z11, des)
sqrt(z11_glm$common.disp) # 0.3689111


# Plot BCVs versus abundance
plotBCV(z11_glm)


# Fit negative bionomial GLM
z11_fit <- glmFit(z11_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool11 - t0_no_Pool11,
t15_PDSvst0_no = t15_PDS_Pool11 - t0_no_Pool11,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool11 - t0_no_Pool11,
t15_PDSvst15_DMSO = t15_PDS_Pool11 - t15_DMSO_Pool11,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool11 - t15_DMSO_Pool11,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool11 - t15_PDS_Pool11,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z11_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z11_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z11_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z11_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z11_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z11_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 1551

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 2594

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 2556

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 3213

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 3515

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 2301


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z11_t15_PDSvst0_no_cpm <- data.table(cpm(z11)[, grepl("t15_PDS|t0_no", colnames(cpm(z11)))], keep.rownames=TRUE)
z11_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool11_1) + log2(t0_no_Pool11_2) + log2(t0_no_Pool11_3))/3]
z11_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z11_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z11_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z11_t15_PDSvst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z11_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z11)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z11)))], keep.rownames=TRUE)
z11_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool11_1) + log2(t0_no_Pool11_2) + log2(t0_no_Pool11_3))/3]
z11_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z11_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z11_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z11_t15_PhenDC3vst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 718
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 705
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 1239

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool11_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
g <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z11$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool11_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures/")




#######
# z12 #
#######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z12$samples)
colnames(des) <- levels(factor(z12$samples$group))
des


# Estimate dispersions
z12_glm <- estimateDisp(z12, des)
sqrt(z12_glm$common.disp) # 0.4016548


# Plot BCVs versus abundance
plotBCV(z12_glm)


# Fit negative bionomial GLM
z12_fit <- glmFit(z12_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool12 - t0_no_Pool12,
t15_PDSvst0_no = t15_PDS_Pool12 - t0_no_Pool12,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool12 - t0_no_Pool12,
t15_PDSvst15_DMSO = t15_PDS_Pool12 - t15_DMSO_Pool12,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool12 - t15_DMSO_Pool12,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool12 - t15_PDS_Pool12,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z12_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z12_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z12_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z12_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z12_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z12_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 467

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 2197

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 2086

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 31

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 1928

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 1901


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z12_t15_PDSvst0_no_cpm <- data.table(cpm(z12)[, grepl("t15_PDS|t0_no", colnames(cpm(z12)))], keep.rownames=TRUE)
z12_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool12_1) + log2(t0_no_Pool12_2) + log2(t0_no_Pool12_3))/3]
z12_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z12_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z12_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z12_t15_PDSvst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z12_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z12)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z12)))], keep.rownames=TRUE)
z12_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool12_1) + log2(t0_no_Pool12_2) + log2(t0_no_Pool12_3))/3]
z12_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z12_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z12_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z12_t15_PhenDC3vst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 418
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 291
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 871

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20161018_Pool12_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
g <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z12$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20161018_Pool12_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20161018/figures/")

```
