
# Analysis of count table (Pools 1 and 2)

```r
library(edgeR)
library(data.table)
library(ggplot2)
library(VennDiagram)
library(reshape)


# Load table of counts into edgeR
data <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20160627/20160627_counts.txt", header = T)
dim(data) # 57454    25


# Add first column to rownames
rownames(data) <- data[,1]
data <- data[2:25]
dim(data) # 57454    24


# Change to a DGE object
z <- DGEList(counts=data)


# How many counts are of each Pool?
reads_total <- sum(z$counts) # 157944712
reads_total_pool1 <- sum(z[,grepl("pool1", colnames(z$counts))]$counts) # 79336962
reads_total_pool2 <- sum(z[,grepl("pool2", colnames(z$counts))]$counts) # 78607750
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts)
  reads_pool_pct <- round(100*reads_pool/reads_total, 2)
  reads_pool_pool1 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool1", colnames(z$counts))]$counts)
  reads_pool_pct_pool1 <- round(100*reads_pool_pool1/reads_total_pool1, 2)
  reads_pool_pool2 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool2", colnames(z$counts))]$counts)
  reads_pool_pct_pool2 <- round(100*reads_pool_pool2/reads_total_pool2, 2)
  hps_pool <- length(rowSums(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts))
  print(sprintf("%s   %s   %s   %s   %s   %s   %s   %s", p, reads_pool, reads_pool_pct, reads_pool_pool1, reads_pool_pct_pool1, reads_pool_pool2, reads_pool_pct_pool2, hps_pool))
#  print(sprintf("%s   %s   %s   %s", p, reads_pool_pct, reads_pool_pct_pool1, reads_pool_pct_pool2))
}

#[1] "Pool1   30.07   58.76   1.12"
#[1] "Pool2   32.31   0.5   64.4"
#[1] "Pool3   0.11   0.08   0.14"
#[1] "Pool4   0.08   0.1   0.06"
#[1] "Pool5   0.44   0.62   0.26"
#[1] "Pool6   0.32   0.58   0.05"
#[1] "Pool7   0.59   0.39   0.8"
#[1] "Pool8   34.53   37.06   31.97"
#[1] "Pool9   0.37   0.43   0.31"
#[1] "Pool10   0.57   0.78   0.35"
#[1] "Pool11   0.21   0.24   0.19"
#[1] "Pool12   0.4   0.46   0.34"


# There is a lot of Pool 8

# in bash:
# tail -n+2 /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20160420/Hs_WG_pool_data_P003_with_12Nic_3.csv | cut -f9 -d "," | sort | uniq -c
#   9600 Pool #1
#   9600 Pool #10
#   8246 Pool #11
#      1 Pool #12
#   9599 Pool #12
#   9600 Pool #2
#   9600 Pool #3
#   9474 Pool #4
#   8906 Pool #5
#   9586 Pool #6
#   9590 Pool #7
#   9600 Pool #8
#   9600 Pool #9


# Change column labels z$counts, change row labels z$samples, add group to z$samples, add Replicate to z$samples
treatments <- c(rep("no", 6), rep(c(rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), 2))
timepoints <- c(rep("t0", 6), rep("t15", 18))
pools <- c(rep("Pool1", 3), rep("Pool2", 3), rep("Pool1", 9), rep("Pool2", 9))
replicates <- rep(c("1", "2", "3"), 8)

colnames(z$counts) <- paste(timepoints, treatments, pools, replicates, sep="_")
rownames(z$samples) <- paste(timepoints, treatments, pools, replicates, sep="_")
z$samples$group <- paste(timepoints, treatments, pools, sep="_")
z$samples$Replicate <- replicates


# Select Pools 1 and 2 as z1 and z2, and redefine z1$samples$lib.size and z2$samples$lib.size
z1 <- z[grepl("Pool1$", rownames(z$counts)), grepl("Pool1", colnames(z$counts))]
z1$samples$lib.size <- as.vector(colSums(z1$counts))
z2 <- z[grepl("Pool2$", rownames(z$counts)), grepl("Pool2", colnames(z$counts))]
z2$samples$lib.size <- as.vector(colSums(z2$counts))


# Pool content table
z_plot <- data.table(z$counts)
setcolorder(z_plot, c("t0_no_Pool1_1", "t0_no_Pool1_2", "t0_no_Pool1_3", "t15_DMSO_Pool1_1", "t15_DMSO_Pool1_2", "t15_DMSO_Pool1_3", "t15_PDS_Pool1_1", "t15_PDS_Pool1_2", "t15_PDS_Pool1_3", "t15_PhenDC3_Pool1_1", "t15_PhenDC3_Pool1_2", "t15_PhenDC3_Pool1_3", "t0_no_Pool2_1", "t0_no_Pool2_2", "t0_no_Pool2_3", "t15_DMSO_Pool2_1", "t15_DMSO_Pool2_2", "t15_DMSO_Pool2_3", "t15_PDS_Pool2_1", "t15_PDS_Pool2_2", "t15_PDS_Pool2_3", "t15_PhenDC3_Pool2_1", "t15_PhenDC3_Pool2_2", "t15_PhenDC3_Pool2_3"))
z_plot[, pool := as.numeric(sapply(rownames(z), function(x) gsub("Pool", "", tail(unlist(strsplit(x, "_")), n=1))))]

z_plot_pcts <- z_plot[, .(t0_no_Pool1_1 = 100*sum(t0_no_Pool1_1)/sum(z_plot[, t0_no_Pool1_1]),
t0_no_Pool1_2 = 100*sum(t0_no_Pool1_2)/sum(z_plot[, t0_no_Pool1_2]),
t0_no_Pool1_3 = 100*sum(t0_no_Pool1_3)/sum(z_plot[, t0_no_Pool1_3]),
t15_DMSO_Pool1_1 = 100*sum(t15_DMSO_Pool1_1)/sum(z_plot[, t15_DMSO_Pool1_1]),
t15_DMSO_Pool1_2 = 100*sum(t15_DMSO_Pool1_2)/sum(z_plot[, t15_DMSO_Pool1_2]),
t15_DMSO_Pool1_3 = 100*sum(t15_DMSO_Pool1_3)/sum(z_plot[, t15_DMSO_Pool1_3]),
t15_PDS_Pool1_1 = 100*sum(t15_PDS_Pool1_1)/sum(z_plot[, t15_PDS_Pool1_1]),
t15_PDS_Pool1_2 = 100*sum(t15_PDS_Pool1_2)/sum(z_plot[, t15_PDS_Pool1_2]),
t15_PDS_Pool1_3 = 100*sum(t15_PDS_Pool1_3)/sum(z_plot[, t15_PDS_Pool1_3]),
t15_PhenDC3_Pool1_1 = 100*sum(t15_PhenDC3_Pool1_1)/sum(z_plot[, t15_PhenDC3_Pool1_1]),
t15_PhenDC3_Pool1_2 = 100*sum(t15_PhenDC3_Pool1_2)/sum(z_plot[, t15_PhenDC3_Pool1_2]),
t15_PhenDC3_Pool1_3 = 100*sum(t15_PhenDC3_Pool1_3)/sum(z_plot[, t15_PhenDC3_Pool1_3]),
t0_no_Pool2_1 = 100*sum(t0_no_Pool2_1)/sum(z_plot[, t0_no_Pool2_1]),
t0_no_Pool2_2 = 100*sum(t0_no_Pool2_2)/sum(z_plot[, t0_no_Pool2_2]),
t0_no_Pool2_3 = 100*sum(t0_no_Pool2_3)/sum(z_plot[, t0_no_Pool2_3]),
t15_DMSO_Pool2_1 = 100*sum(t15_DMSO_Pool2_1)/sum(z_plot[, t15_DMSO_Pool2_1]),
t15_DMSO_Pool2_2 = 100*sum(t15_DMSO_Pool2_2)/sum(z_plot[, t15_DMSO_Pool2_2]),
t15_DMSO_Pool2_3 = 100*sum(t15_DMSO_Pool2_3)/sum(z_plot[, t15_DMSO_Pool2_3]),
t15_PDS_Pool2_1 = 100*sum(t15_PDS_Pool2_1)/sum(z_plot[, t15_PDS_Pool2_1]),
t15_PDS_Pool2_2 = 100*sum(t15_PDS_Pool2_2)/sum(z_plot[, t15_PDS_Pool2_2]),
t15_PDS_Pool2_3 = 100*sum(t15_PDS_Pool2_3)/sum(z_plot[, t15_PDS_Pool2_3]),
t15_PhenDC3_Pool2_1 = 100*sum(t15_PhenDC3_Pool2_1)/sum(z_plot[, t15_PhenDC3_Pool2_1]),
t15_PhenDC3_Pool2_2 = 100*sum(t15_PhenDC3_Pool2_2)/sum(z_plot[, t15_PhenDC3_Pool2_2]),
t15_PhenDC3_Pool2_3 = 100*sum(t15_PhenDC3_Pool2_3)/sum(z_plot[, t15_PhenDC3_Pool2_3])),
keyby = pool]

write.table(z_plot_pcts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160930_Pool1_Pool2_library_content_table.txt", quote = FALSE, sep = "\t", row.names = FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160930_Pool1_Pool2_library_content_table.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")


# Pool content plot
z_plot_pcts_melt <- melt(z_plot_pcts, id = "pool", variable.name = "library", value.name = "pct")

gg <- ggplot(z_plot_pcts_melt[order(-pool)], aes(x = library, y = pct, fill = factor(pool))) +
geom_bar(stat="identity") +
xlab("") +
ylab("% Reads") +
theme_classic() +
scale_fill_discrete(name="Pool") +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_text(size = 16)) +
scale_x_discrete(labels = paste(paste(colnames(z_plot)[1:24], "(n =", as.character(colSums(z_plot)[1:24])), ")", sep=""))

ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160930_Pool1_Pool2_library_content_plot.pdf", width = 16/2.54, height = 16/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160930_Pool1_Pool2_library_content_plot.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")


# Write raw counts to table (Pools 1 and 2)
write.table(z1$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_counts.txt", quote = FALSE, sep = "\t")
write.table(z2$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool2_counts.txt", quote = FALSE, sep = "\t")

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool2_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z1$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z1$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z1$counts)[rowSums(z1$counts) > 300000], decreasing=T)
#C16orf73__sherwood_1u__1__1_Pool1
#                           313098

par(mfrow=c(2,1))
barplot(colSums(z2$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z2$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z2$counts)[rowSums(z2$counts) > 1000000], decreasing=T)
#HEPACAM__sherwood_1u__2__2_Pool2    TAS2R42__sherwood__4__4_Pool2
#                         3885507                          1428436

# HEPACAM and TAS2R42 dominate Pool2

# Make MDS plots to visualise relationships between replicate samples

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z1, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("bottomright", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures")

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool2_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z2, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("bottomright", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool2_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures")



######
# z1 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z1$samples)
colnames(des) <- levels(factor(z1$samples$group))
des


# Estimate dispersions
z1_glm <- estimateDisp(z1, des)
sqrt(z1_glm$common.disp) # 0.5869629


# Plot BCVs versus abundance
plotBCV(z1_glm)


# Fit negative bionomial GLM
z1_fit <- glmFit(z1_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool1 - t0_no_Pool1,
t15_PDSvst0_no = t15_PDS_Pool1 - t0_no_Pool1,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool1 - t0_no_Pool1,
t15_PDSvst15_DMSO = t15_PDS_Pool1 - t15_DMSO_Pool1,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool1 - t15_DMSO_Pool1,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool1 - t15_PDS_Pool1,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z1_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z1_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z1_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z1_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z1_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z1_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 310

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 670

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 886

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 0

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 279

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 207


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z1_t15_PDSvst0_no_cpm <- data.table(cpm(z1)[, grepl("t15_PDS|t0_no", colnames(cpm(z1)))], keep.rownames=TRUE)
z1_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool1_1) + log2(t0_no_Pool1_2) + log2(t0_no_Pool1_3))/3]
z1_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z1_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z1_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z1_t15_PDSvst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z1_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z1)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z1)))], keep.rownames=TRUE)
z1_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool1_1) + log2(t0_no_Pool1_2) + log2(t0_no_Pool1_3))/3]
z1_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z1_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z1_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z1_t15_PhenDC3vst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 251
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 168
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 312

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160627_Pool1_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z1$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160627_Pool1_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")



######
# z2 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z2$samples)
colnames(des) <- levels(factor(z2$samples$group))
des


# Estimate dispersions
z2_glm <- estimateDisp(z2, des)
sqrt(z2_glm$common.disp) # 0.5758254


# Plot BCVs versus abundance
plotBCV(z2_glm)


# Fit negative bionomial GLM
z2_fit <- glmFit(z2_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool2 - t0_no_Pool2,
t15_PDSvst0_no = t15_PDS_Pool2 - t0_no_Pool2,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool2 - t0_no_Pool2,
t15_PDSvst15_DMSO = t15_PDS_Pool2 - t15_DMSO_Pool2,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool2 - t15_DMSO_Pool2,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool2 - t15_PDS_Pool2,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z2_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z2_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z2_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z2_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z2_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z2_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 404

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 664

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 920

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 34

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 746

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 444


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z2_t15_PDSvst0_no_cpm <- data.table(cpm(z2)[, grepl("t15_PDS|t0_no", colnames(cpm(z2)))], keep.rownames=TRUE)
z2_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool2_1) + log2(t0_no_Pool2_2) + log2(t0_no_Pool2_3))/3]
z2_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z2_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z2_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z2_t15_PDSvst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z2_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z2)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z2)))], keep.rownames=TRUE)
z2_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool2_1) + log2(t0_no_Pool2_2) + log2(t0_no_Pool2_3))/3]
z2_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z2_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z2_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z2_t15_PhenDC3vst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 226
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 208
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 314

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z2$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")



############
# z2_clean # no HEPACAM__sherwood_1u__2__2_Pool2 and TAS2R42__sherwood__4__4_Pool2
############

# Remove HEPACAM__sherwood_1u__2__2_Pool2 and TAS2R42__sherwood__4__4_Pool2, and redefine z2_clean$samples$lib.size
z2_clean <- z2[!grepl("HEPACAM__sherwood_1u__2__2_Pool2|TAS2R42__sherwood__4__4_Pool2", rownames(z2)),]
z2_clean$samples$lib.size <- as.vector(colSums(z2_clean$counts))


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z2_clean$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z2_clean$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z2_clean$counts)[rowSums(z2_clean$counts) > 500000], decreasing=T)
#CBX3__sherwood_1u__2_Pool2 SESN2__sherwood_1u__4__4_Pool2
#                    588125                         338343


# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z2_clean$samples)
colnames(des) <- levels(factor(z2_clean$samples$group))
des


# Estimate dispersions
z2_clean_glm <- estimateDisp(z2_clean, des)
sqrt(z2_clean_glm$common.disp) # 0.5745294


# Plot BCVs versus abundance
plotBCV(z2_clean_glm)


# Fit negative bionomial GLM
z2_clean_fit <- glmFit(z2_clean_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool2 - t0_no_Pool2,
t15_PDSvst0_no = t15_PDS_Pool2 - t0_no_Pool2,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool2 - t0_no_Pool2,
t15_PDSvst15_DMSO = t15_PDS_Pool2 - t15_DMSO_Pool2,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool2 - t15_DMSO_Pool2,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool2 - t15_PDS_Pool2,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z2_clean_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z2_clean_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z2_clean_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z2_clean_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z2_clean_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z2_clean_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 432

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 666

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 940

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 30

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 753

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 460


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z2_clean_t15_PDSvst0_no_cpm <- data.table(cpm(z2_clean)[, grepl("t15_PDS|t0_no", colnames(cpm(z2_clean)))], keep.rownames=TRUE)
z2_clean_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool2_1) + log2(t0_no_Pool2_2) + log2(t0_no_Pool2_3))/3]
z2_clean_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z2_clean_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z2_clean_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z2_clean_t15_PDSvst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_clean_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_clean_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z2_clean_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z2_clean)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z2_clean)))], keep.rownames=TRUE)
z2_clean_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool2_1) + log2(t0_no_Pool2_2) + log2(t0_no_Pool2_3))/3]
z2_clean_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z2_clean_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z2_clean_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z2_clean_t15_PhenDC3vst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_clean_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_clean_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 241
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 226
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 325

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool2_clean_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_clean_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_clean_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_clean_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z2_clean$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool2_clean_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160627/figures/")

```



# Analysis of count table (Pools 5 and 10)

```r
library(edgeR)
library(data.table)
library(ggplot2)
library(VennDiagram)
library(reshape)


# Load table of counts into edgeR
data <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20160629/20160629_counts.txt", header = T)
dim(data) #  49570   25


# Add first column to rownames
rownames(data) <- data[,1]
data <- data[2:25]
dim(data) # 49570    24


# Change to a DGE object
z <- DGEList(counts=data)


# How many counts are of each Pool?
reads_total <- sum(z$counts) # 187611783
reads_total_pool5 <- sum(z[,grepl("P5", colnames(z$counts))]$counts) # 96921319
reads_total_pool10 <- sum(z[,grepl("P10", colnames(z$counts))]$counts) # 90690464
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts)
  reads_pool_pct <- round(100*reads_pool/reads_total, 2)
  reads_pool_pool5 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("P5", colnames(z$counts))]$counts)
  reads_pool_pct_pool5 <- round(100*reads_pool_pool5/reads_total_pool5, 2)
  reads_pool_pool10 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("P10", colnames(z$counts))]$counts)
  reads_pool_pct_pool10 <- round(100*reads_pool_pool10/reads_total_pool10, 2)
  hps_pool <- length(rowSums(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts))
  print(sprintf("%s   %s   %s   %s   %s   %s   %s   %s", p, reads_pool, reads_pool_pct, reads_pool_pool5, reads_pool_pct_pool5, reads_pool_pool10, reads_pool_pct_pool10, hps_pool))
#  print(sprintf("%s   %s   %s   %s", p, reads_pool_pct, reads_pool_pct_pool5, reads_pool_pct_pool10))
}

#[1] "Pool1   0.12   0.15   0.1"
#[1] "Pool2   0.22   0.19   0.25"
#[1] "Pool3   0.21   0.2   0.23"
#[1] "Pool4   0.43   0.6   0.26"
#[1] "Pool5   40.46   68.47   10.53"
#[1] "Pool6   0.61   0.97   0.22"
#[1] "Pool7   0.88   1.17   0.57"
#[1] "Pool8   24.72   24.46   25"
#[1] "Pool9   0.63   0.66   0.6"
#[1] "Pool10   29.58   1.68   59.4"
#[1] "Pool11   0.98   0.64   1.34"
#[1] "Pool12   1.15   0.81   1.51"


# There is less Pool 8 than in 20160627_counts.txt, still ~25%, but there also seems to be more Pool 5 than 10, whereas Pools 1 and 2 in 20160627_counts.txt were overall the same.


# Change column labels z$counts, change row labels z$samples, add group to z$samples, add Replicate to z$samples
treatments <- c(rep("no", 6), rep(c(rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), 2))
timepoints <- c(rep("t0", 6), rep("t15", 18))
pools <- c(rep("Pool5", 3), rep("Pool10", 3), rep("Pool5", 9), rep("Pool10", 9))
replicates <- rep(c("1", "2", "3"), 8)

colnames(z$counts) <- paste(timepoints, treatments, pools, replicates, sep="_")
rownames(z$samples) <- paste(timepoints, treatments, pools, replicates, sep="_")
z$samples$group <- paste(timepoints, treatments, pools, sep="_")
z$samples$Replicate <- replicates


# Select Pools 5 and 10 as z5 and z10, and redefine z5$samples$lib.size and z10$samples$lib.size
z5 <- z[grepl("Pool5$", rownames(z$counts)), grepl("Pool5", colnames(z$counts))]
z5$samples$lib.size <- as.vector(colSums(z5$counts))
z10 <- z[grepl("Pool10$", rownames(z$counts)), grepl("Pool10", colnames(z$counts))]
z10$samples$lib.size <- as.vector(colSums(z10$counts))


# Pool content table
z_plot <- data.table(z$counts)
setcolorder(z_plot, c("t0_no_Pool5_1", "t0_no_Pool5_2", "t0_no_Pool5_3", "t15_DMSO_Pool5_1", "t15_DMSO_Pool5_2", "t15_DMSO_Pool5_3", "t15_PDS_Pool5_1", "t15_PDS_Pool5_2", "t15_PDS_Pool5_3", "t15_PhenDC3_Pool5_1", "t15_PhenDC3_Pool5_2", "t15_PhenDC3_Pool5_3", "t0_no_Pool10_1", "t0_no_Pool10_2", "t0_no_Pool10_3", "t15_DMSO_Pool10_1", "t15_DMSO_Pool10_2", "t15_DMSO_Pool10_3", "t15_PDS_Pool10_1", "t15_PDS_Pool10_2", "t15_PDS_Pool10_3", "t15_PhenDC3_Pool10_1", "t15_PhenDC3_Pool10_2", "t15_PhenDC3_Pool10_3"))
z_plot[, pool := as.numeric(sapply(rownames(z), function(x) gsub("Pool", "", tail(unlist(strsplit(x, "_")), n=1))))]

z_plot_pcts <- z_plot[, .(t0_no_Pool5_1 = 100*sum(t0_no_Pool5_1)/sum(z_plot[, t0_no_Pool5_1]),
t0_no_Pool5_2 = 100*sum(t0_no_Pool5_2)/sum(z_plot[, t0_no_Pool5_2]),
t0_no_Pool5_3 = 100*sum(t0_no_Pool5_3)/sum(z_plot[, t0_no_Pool5_3]),
t15_DMSO_Pool5_1 = 100*sum(t15_DMSO_Pool5_1)/sum(z_plot[, t15_DMSO_Pool5_1]),
t15_DMSO_Pool5_2 = 100*sum(t15_DMSO_Pool5_2)/sum(z_plot[, t15_DMSO_Pool5_2]),
t15_DMSO_Pool5_3 = 100*sum(t15_DMSO_Pool5_3)/sum(z_plot[, t15_DMSO_Pool5_3]),
t15_PDS_Pool5_1 = 100*sum(t15_PDS_Pool5_1)/sum(z_plot[, t15_PDS_Pool5_1]),
t15_PDS_Pool5_2 = 100*sum(t15_PDS_Pool5_2)/sum(z_plot[, t15_PDS_Pool5_2]),
t15_PDS_Pool5_3 = 100*sum(t15_PDS_Pool5_3)/sum(z_plot[, t15_PDS_Pool5_3]),
t15_PhenDC3_Pool5_1 = 100*sum(t15_PhenDC3_Pool5_1)/sum(z_plot[, t15_PhenDC3_Pool5_1]),
t15_PhenDC3_Pool5_2 = 100*sum(t15_PhenDC3_Pool5_2)/sum(z_plot[, t15_PhenDC3_Pool5_2]),
t15_PhenDC3_Pool5_3 = 100*sum(t15_PhenDC3_Pool5_3)/sum(z_plot[, t15_PhenDC3_Pool5_3]),
t0_no_Pool10_1 = 100*sum(t0_no_Pool10_1)/sum(z_plot[, t0_no_Pool10_1]),
t0_no_Pool10_2 = 100*sum(t0_no_Pool10_2)/sum(z_plot[, t0_no_Pool10_2]),
t0_no_Pool10_3 = 100*sum(t0_no_Pool10_3)/sum(z_plot[, t0_no_Pool10_3]),
t15_DMSO_Pool10_1 = 100*sum(t15_DMSO_Pool10_1)/sum(z_plot[, t15_DMSO_Pool10_1]),
t15_DMSO_Pool10_2 = 100*sum(t15_DMSO_Pool10_2)/sum(z_plot[, t15_DMSO_Pool10_2]),
t15_DMSO_Pool10_3 = 100*sum(t15_DMSO_Pool10_3)/sum(z_plot[, t15_DMSO_Pool10_3]),
t15_PDS_Pool10_1 = 100*sum(t15_PDS_Pool10_1)/sum(z_plot[, t15_PDS_Pool10_1]),
t15_PDS_Pool10_2 = 100*sum(t15_PDS_Pool10_2)/sum(z_plot[, t15_PDS_Pool10_2]),
t15_PDS_Pool10_3 = 100*sum(t15_PDS_Pool10_3)/sum(z_plot[, t15_PDS_Pool10_3]),
t15_PhenDC3_Pool10_1 = 100*sum(t15_PhenDC3_Pool10_1)/sum(z_plot[, t15_PhenDC3_Pool10_1]),
t15_PhenDC3_Pool10_2 = 100*sum(t15_PhenDC3_Pool10_2)/sum(z_plot[, t15_PhenDC3_Pool10_2]),
t15_PhenDC3_Pool10_3 = 100*sum(t15_PhenDC3_Pool10_3)/sum(z_plot[, t15_PhenDC3_Pool10_3])),
keyby = pool]

write.table(z_plot_pcts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160930_Pool5_Pool10_library_content_table.txt", quote = FALSE, sep = "\t", row.names = FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160930_Pool5_Pool10_library_content_table.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")


# Pool content plot
z_plot_pcts_melt <- melt(z_plot_pcts, id = "pool", variable.name = "library", value.name = "pct")

gg <- ggplot(z_plot_pcts_melt[order(-pool)], aes(x = library, y = pct, fill = factor(pool))) +
geom_bar(stat="identity") +
xlab("") +
ylab("% Reads") +
theme_classic() +
scale_fill_discrete(name="Pool") +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_text(size = 16)) +
scale_x_discrete(labels = paste(paste(colnames(z_plot)[1:24], "(n =", as.character(colSums(z_plot)[1:24])), ")", sep=""))

ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160930_Pool5_Pool10_library_content_plot.pdf", width = 16/2.54, height = 16/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160930_Pool5_Pool10_library_content_plot.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures/")


# Write raw counts to table (Pools 5 and 10)
write.table(z5$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_counts.txt", quote = FALSE, sep = "\t")
write.table(z10$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_counts.txt", quote = FALSE, sep = "\t")

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z5$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z5$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z5$counts)[rowSums(z5$counts) > 150000], decreasing=T)
#UGT2B10__sherwood__3__2_Pool5
#                       185542

par(mfrow=c(2,1))
barplot(colSums(z10$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z10$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z10$counts)[rowSums(z10$counts) > 700000], decreasing=T)
#GPKOW__6__4_Pool10
#            749021


# Make MDS plots to visualise relationships between replicate samples

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z5, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("topleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures")

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z10, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("bottomright", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures")



######
# z5 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z5$samples)
colnames(des) <- levels(factor(z5$samples$group))
des


# Estimate dispersions
z5_glm <- estimateDisp(z5, des)
sqrt(z5_glm$common.disp) # 0.6283057


# Plot BCVs versus abundance
plotBCV(z5_glm)


# Fit negative bionomial GLM
z5_fit <- glmFit(z5_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool5 - t0_no_Pool5,
t15_PDSvst0_no = t15_PDS_Pool5 - t0_no_Pool5,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool5 - t0_no_Pool5,
t15_PDSvst15_DMSO = t15_PDS_Pool5 - t15_DMSO_Pool5,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool5 - t15_DMSO_Pool5,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool5 - t15_PDS_Pool5,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z5_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z5_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z5_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z5_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z5_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z5_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 331

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 755

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 836

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 1

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 202

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 166


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z5_t15_PDSvst0_no_cpm <- data.table(cpm(z5)[, grepl("t15_PDS|t0_no", colnames(cpm(z5)))], keep.rownames=TRUE)
z5_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool5_1) + log2(t0_no_Pool5_2) + log2(t0_no_Pool5_3))/3]
z5_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z5_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z5_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z5_t15_PDSvst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z5_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z5)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z5)))], keep.rownames=TRUE)
z5_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool5_1) + log2(t0_no_Pool5_2) + log2(t0_no_Pool5_3))/3]
z5_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z5_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z5_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z5_t15_PhenDC3vst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 272
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 178
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 342

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool5_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
g <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z5$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool5_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures/")



######
# z10 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z10$samples)
colnames(des) <- levels(factor(z10$samples$group))
des


# Estimate dispersions
z10_glm <- estimateDisp(z10, des)
sqrt(z10_glm$common.disp) # 0.5504013


# Plot BCVs versus abundance
plotBCV(z10_glm)


# Fit negative bionomial GLM
z10_fit <- glmFit(z10_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool10 - t0_no_Pool10,
t15_PDSvst0_no = t15_PDS_Pool10 - t0_no_Pool10,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool10 - t0_no_Pool10,
t15_PDSvst15_DMSO = t15_PDS_Pool10 - t15_DMSO_Pool10,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool10 - t15_DMSO_Pool10,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool10 - t15_PDS_Pool10,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z10_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z10_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z10_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z10_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z10_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z10_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 336

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 354

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 544

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 4

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 403

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 271


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z10_t15_PDSvst0_no_cpm <- data.table(cpm(z10)[, grepl("t15_PDS|t0_no", colnames(cpm(z10)))], keep.rownames=TRUE)
z10_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool10_1) + log2(t0_no_Pool10_2) + log2(t0_no_Pool10_3))/3]
z10_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z10_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z10_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z10_t15_PDSvst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z10_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z10)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z10)))], keep.rownames=TRUE)
z10_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool10_1) + log2(t0_no_Pool10_2) + log2(t0_no_Pool10_3))/3]
z10_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z10_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z10_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]
gg <- ggplot(z10_t15_PhenDC3vst0_no_cpm[order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) + geom_point(size=0.5) + xlab(expression("log"[2]*"(t0)")) + ylab(expression("log"[2]*"(t15/t0)")) + theme_bw() + scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen")) + ylim(-12,4) + xlim(-2,12)
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 187
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 126
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 150

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160629_Pool10_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
gg <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z10$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160629_Pool10_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160629/figures/")


```



# Analysis of trends in significantly abundant hairpins and related genes


```python
with open("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20160420/Hs_WG_pool_data_P003_with_12Nic_3.csv", "rb") as f:
	data = f.readlines()

gene_hairpin_pool = {}

for hp in data[1:]:
  fields = hp.split(",")
  name = fields[4]
  gene = fields[4].split("__")[0]
  pool = "".join([fields[8].split()[0], fields[8].split()[1][1:]])
  if gene in gene_hairpin_pool:
    gene_hairpin_pool[gene].append((name, pool))
  else:
    gene_hairpin_pool[gene] = [(name, pool)]


len(gene_hairpin_pool) # 18937

```
