
# Analysis of count table (Pools 3 and 4)

```R
library(edgeR)
library(data.table)
library(ggplot2)
library(VennDiagram)
library(reshape)


# Enlarge the view width when printing tables
options(width = 300)


# Load table of counts into edgeR
data <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20160902/20160902_counts.txt", header = T)
dim(data) #  87470    25


# Add first column to rownames
rownames(data) <- data[,1]
data <- data[2:25]
dim(data) # 87470    24


# Change to a DGE object
z <- DGEList(counts=data)


# How many counts are of each Pool?
reads_total <- sum(z$counts) # 143980363
reads_total_pool3 <- sum(z[,grepl("pool3", colnames(z$counts))]$counts) # 71185402
reads_total_pool4 <- sum(z[,grepl("pool4", colnames(z$counts))]$counts) # 72794961
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts)
  reads_pool_pct <- round(100*reads_pool/reads_total, 2)
  reads_pool_pool3 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool3", colnames(z$counts))]$counts)
  reads_pool_pct_pool3 <- round(100*reads_pool_pool3/reads_total_pool3, 2)
  reads_pool_pool4 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool4", colnames(z$counts))]$counts)
  reads_pool_pct_pool4 <- round(100*reads_pool_pool4/reads_total_pool4, 2)
  hps_pool <- length(rowSums(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts))
  print(sprintf("%s   %s   %s   %s   %s   %s   %s   %s", p, reads_pool, reads_pool_pct, reads_pool_pool3, reads_pool_pct_pool3, reads_pool_pool4, reads_pool_pct_pool4, hps_pool))
}

#[1] "Pool1   231708   0.16   137944   0.19   93764   0.13   6922"
#[1] "Pool2   444538   0.31   318748   0.45   125790   0.17   8586"
#[1] "Pool3   56857887   39.49   55140204   77.46   1717683   2.36   9518"
#[1] "Pool4   73547867   51.08   10388472   14.59   63159395   86.76   8386"
#[1] "Pool5   1566662   1.09   286392   0.4   1280270   1.76   7439"
#[1] "Pool6   223221   0.16   111685   0.16   111536   0.15   2859"
#[1] "Pool7   1098795   0.76   802176   1.13   296619   0.41   7578"
#[1] "Pool8   7307013   5.08   3386720   4.76   3920293   5.39   9570"
#[1] "Pool9   1662879   1.15   275550   0.39   1387329   1.91   8814"
#[1] "Pool10   225140   0.16   106031   0.15   119109   0.16   7835"
#[1] "Pool11   182363   0.13   50829   0.07   131534   0.18   551"
#[1] "Pool12   632290   0.44   180651   0.25   451639   0.62   9412"


# There is way less Pool 8 than in 20160627_counts.txt and 20160629_counts.txt, now ~5%


# Change column labels z$counts, change row labels z$samples, add group to z$samples, add Replicate to z$samples
treatments <- c(rep("no", 6), rep("DMSO", 6), rep("PDS", 6), rep("PhenDC3", 6))
timepoints <- c(rep("t0", 6), rep("t15", 18))
pools <- c(rep(c(rep("Pool3", 3), rep("Pool4", 3)), 4))
replicates <- rep(c("1", "2", "3"), 8)

colnames(z$counts) <- paste(timepoints, treatments, pools, replicates, sep="_")
rownames(z$samples) <- paste(timepoints, treatments, pools, replicates, sep="_")
z$samples$group <- paste(timepoints, treatments, pools, sep="_")
z$samples$Replicate <- replicates


# Select Pools 3 and 4 as z3 and z4, and redefine z3$samples$lib.size and z4$samples$lib.size
z3 <- z[grepl("Pool3$", rownames(z$counts)), grepl("Pool3", colnames(z$counts))]
z3$samples$lib.size <- as.vector(colSums(z3$counts))
z4 <- z[grepl("Pool4$", rownames(z$counts)), grepl("Pool4", colnames(z$counts))]
z4$samples$lib.size <- as.vector(colSums(z4$counts))


# When inspecting z3$samples, t15_PhenDC3_Pool3_1 has considerably less reads than the rest of libraries, also t15_PhenDC3_Pool3_3
# When inspecting z4$samples, everything looks even.
# z1, z2, z5, z10 from before also looked even.

# Further investigation - let's look at the distribution of reads in the three replicates of t15_PhenDC3 pool3
reads_total_t15_PhenDC3_Pool3_1 <- sum(z[,grepl("t15_PhenDC3_Pool3_1", colnames(z$counts))]$counts) # 5696112
reads_total_t15_PhenDC3_Pool3_2 <- sum(z[,grepl("t15_PhenDC3_Pool3_2", colnames(z$counts))]$counts) # 6428738
reads_total_t15_PhenDC3_Pool3_3 <- sum(z[,grepl("t15_PhenDC3_Pool3_3", colnames(z$counts))]$counts) # 6611642
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool_t15_PhenDC3_Pool3_1 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("t15_PhenDC3_Pool3_1", colnames(z$counts))]$counts)
  reads_pool_pct_t15_PhenDC3_Pool3_1 <- round(100*reads_pool_t15_PhenDC3_Pool3_1/reads_total_t15_PhenDC3_Pool3_1, 2)
  reads_pool_t15_PhenDC3_Pool3_2 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("t15_PhenDC3_Pool3_2", colnames(z$counts))]$counts)
  reads_pool_pct_t15_PhenDC3_Pool3_2 <- round(100*reads_pool_t15_PhenDC3_Pool3_2/reads_total_t15_PhenDC3_Pool3_2, 2)
  reads_pool_t15_PhenDC3_Pool3_3 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("t15_PhenDC3_Pool3_3", colnames(z$counts))]$counts)
  reads_pool_pct_t15_PhenDC3_Pool3_3 <- round(100*reads_pool_t15_PhenDC3_Pool3_3/reads_total_t15_PhenDC3_Pool3_3, 2)
  print(sprintf("%s   %s   %s   %s   %s   %s   %s", p, reads_pool_t15_PhenDC3_Pool3_1, reads_pool_pct_t15_PhenDC3_Pool3_1, reads_pool_t15_PhenDC3_Pool3_2, reads_pool_pct_t15_PhenDC3_Pool3_2, reads_pool_t15_PhenDC3_Pool3_3, reads_pool_pct_t15_PhenDC3_Pool3_3))
}

#[1] "Pool1   13032   0.23   80940   1.26   23325   0.35"
#[1] "Pool2   27499   0.48   21438   0.33   60591   0.92"
#[1] "Pool3   949638   16.67   5350599   83.23   1393522   21.08"
#[1] "Pool4   4422966   77.65   769585   11.97   4811477   72.77"
#[1] "Pool5   89017   1.56   19607   0.3   92821   1.4"
#[1] "Pool6   9001   0.16   9371   0.15   9516   0.14"
#[1] "Pool7   26597   0.47   73894   1.15   32329   0.49"
#[1] "Pool8   35271   0.62   72036   1.12   54159   0.82"
#[1] "Pool9   92005   1.62   14090   0.22   100061   1.51"
#[1] "Pool10   4087   0.07   4474   0.07   5654   0.09"
#[1] "Pool11   7364   0.13   2825   0.04   8566   0.13"
#[1] "Pool12   19635   0.34   9879   0.15   19621   0.3"

# t15_PhenDC3_Pool3_1: 78% (Pool4)
# t15_PhenDC3_Pool3_3: 73% (Pool4)


# Pool content table
z_plot <- data.table(z$counts)
setcolorder(z_plot, c("t0_no_Pool3_1", "t0_no_Pool3_2", "t0_no_Pool3_3", "t15_DMSO_Pool3_1", "t15_DMSO_Pool3_2", "t15_DMSO_Pool3_3", "t15_PDS_Pool3_1", "t15_PDS_Pool3_2", "t15_PDS_Pool3_3", "t15_PhenDC3_Pool3_1", "t15_PhenDC3_Pool3_2", "t15_PhenDC3_Pool3_3", "t0_no_Pool4_1", "t0_no_Pool4_2", "t0_no_Pool4_3", "t15_DMSO_Pool4_1", "t15_DMSO_Pool4_2", "t15_DMSO_Pool4_3", "t15_PDS_Pool4_1", "t15_PDS_Pool4_2", "t15_PDS_Pool4_3", "t15_PhenDC3_Pool4_1", "t15_PhenDC3_Pool4_2", "t15_PhenDC3_Pool4_3"))
z_plot[, pool := as.numeric(sapply(rownames(z), function(x) gsub("Pool", "", tail(unlist(strsplit(x, "_")), n=1))))]

z_plot_pcts <- z_plot[, .(t0_no_Pool3_1 = 100*sum(t0_no_Pool3_1)/sum(z_plot[, t0_no_Pool3_1]),
t0_no_Pool3_2 = 100*sum(t0_no_Pool3_2)/sum(z_plot[, t0_no_Pool3_2]),
t0_no_Pool3_3 = 100*sum(t0_no_Pool3_3)/sum(z_plot[, t0_no_Pool3_3]),
t15_DMSO_Pool3_1 = 100*sum(t15_DMSO_Pool3_1)/sum(z_plot[, t15_DMSO_Pool3_1]),
t15_DMSO_Pool3_2 = 100*sum(t15_DMSO_Pool3_2)/sum(z_plot[, t15_DMSO_Pool3_2]),
t15_DMSO_Pool3_3 = 100*sum(t15_DMSO_Pool3_3)/sum(z_plot[, t15_DMSO_Pool3_3]),
t15_PDS_Pool3_1 = 100*sum(t15_PDS_Pool3_1)/sum(z_plot[, t15_PDS_Pool3_1]),
t15_PDS_Pool3_2 = 100*sum(t15_PDS_Pool3_2)/sum(z_plot[, t15_PDS_Pool3_2]),
t15_PDS_Pool3_3 = 100*sum(t15_PDS_Pool3_3)/sum(z_plot[, t15_PDS_Pool3_3]),
t15_PhenDC3_Pool3_1 = 100*sum(t15_PhenDC3_Pool3_1)/sum(z_plot[, t15_PhenDC3_Pool3_1]),
t15_PhenDC3_Pool3_2 = 100*sum(t15_PhenDC3_Pool3_2)/sum(z_plot[, t15_PhenDC3_Pool3_2]),
t15_PhenDC3_Pool3_3 = 100*sum(t15_PhenDC3_Pool3_3)/sum(z_plot[, t15_PhenDC3_Pool3_3]),
t0_no_Pool4_1 = 100*sum(t0_no_Pool4_1)/sum(z_plot[, t0_no_Pool4_1]),
t0_no_Pool4_2 = 100*sum(t0_no_Pool4_2)/sum(z_plot[, t0_no_Pool4_2]),
t0_no_Pool4_3 = 100*sum(t0_no_Pool4_3)/sum(z_plot[, t0_no_Pool4_3]),
t15_DMSO_Pool4_1 = 100*sum(t15_DMSO_Pool4_1)/sum(z_plot[, t15_DMSO_Pool4_1]),
t15_DMSO_Pool4_2 = 100*sum(t15_DMSO_Pool4_2)/sum(z_plot[, t15_DMSO_Pool4_2]),
t15_DMSO_Pool4_3 = 100*sum(t15_DMSO_Pool4_3)/sum(z_plot[, t15_DMSO_Pool4_3]),
t15_PDS_Pool4_1 = 100*sum(t15_PDS_Pool4_1)/sum(z_plot[, t15_PDS_Pool4_1]),
t15_PDS_Pool4_2 = 100*sum(t15_PDS_Pool4_2)/sum(z_plot[, t15_PDS_Pool4_2]),
t15_PDS_Pool4_3 = 100*sum(t15_PDS_Pool4_3)/sum(z_plot[, t15_PDS_Pool4_3]),
t15_PhenDC3_Pool4_1 = 100*sum(t15_PhenDC3_Pool4_1)/sum(z_plot[, t15_PhenDC3_Pool4_1]),
t15_PhenDC3_Pool4_2 = 100*sum(t15_PhenDC3_Pool4_2)/sum(z_plot[, t15_PhenDC3_Pool4_2]),
t15_PhenDC3_Pool4_3 = 100*sum(t15_PhenDC3_Pool4_3)/sum(z_plot[, t15_PhenDC3_Pool4_3])),
keyby = pool]

write.table(z_plot_pcts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_Pool4_library_content_table.txt", quote = FALSE, sep = "\t", row.names = FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_Pool4_library_content_table.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")


# Pool content plot
z_plot_pcts_melt <- melt(z_plot_pcts, id = "pool", variable.name = "library", value.name = "pct")

gg <- ggplot(z_plot_pcts_melt[order(-pool)], aes(x = library, y = pct, fill = factor(pool))) +
geom_bar(stat="identity") +
xlab("") +
ylab("% Reads") +
theme_classic() +
scale_fill_discrete(name="Pool") +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_text(size = 16)) +
scale_x_discrete(labels = paste(paste(colnames(z_plot)[1:24], "(n =", as.character(colSums(z_plot)[1:24])), ")", sep=""))

ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_Pool4_library_content_plot.pdf", width = 16/2.54, height = 16/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_Pool4_library_content_plot.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")



# Write raw counts to table (Pools 3 and 4)
write.table(z3$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_counts.txt", quote = FALSE, sep = "\t")
write.table(z4$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_counts.txt", quote = FALSE, sep = "\t")

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z3$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z3$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z3$counts)[rowSums(z3$counts) > 150000], decreasing=T)
#TP53__sherwood_1u__1__1_Pool3   MYADM__sherwood__1__1_Pool3
#                       166880                        151165

par(mfrow=c(2,1))
barplot(colSums(z4$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z4$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z4$counts)[rowSums(z4$counts) > 500000], decreasing=T)
#MKKS__sherwood__3__3_Pool4     CLCA2__sensor__1_Pool4 TANK__sherwood__3__3_Pool4
#                   1040115                     841746                     523728


# Make MDS plots to visualise relationships between replicate samples

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z3, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("bottomleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures")

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z4, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("bottomleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures")


######
# z3 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z3$samples)
colnames(des) <- levels(factor(z3$samples$group))
des


# Estimate dispersions
z3_glm <- estimateDisp(z3, des)
sqrt(z3_glm$common.disp) # 0.3863804


# Plot BCVs versus abundance
plotBCV(z3_glm)


# Fit negative bionomial GLM
z3_fit <- glmFit(z3_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool3 - t0_no_Pool3,
t15_PDSvst0_no = t15_PDS_Pool3 - t0_no_Pool3,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool3 - t0_no_Pool3,
t15_PDSvst15_DMSO = t15_PDS_Pool3 - t15_DMSO_Pool3,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool3 - t15_DMSO_Pool3,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool3 - t15_PDS_Pool3,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z3_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z3_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z3_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z3_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z3_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z3_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 891

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 1123

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 843

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 2

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 770

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 456


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z3_t15_PDSvst0_no_cpm <- data.table(cpm(z3)[, grepl("t15_PDS|t0_no", colnames(cpm(z3)))], keep.rownames=TRUE)
z3_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool3_1) + log2(t0_no_Pool3_2) + log2(t0_no_Pool3_3))/3]
z3_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z3_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z3_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z3_t15_PDSvst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z3_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z3)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z3)))], keep.rownames=TRUE)
z3_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool3_1) + log2(t0_no_Pool3_2) + log2(t0_no_Pool3_3))/3]
z3_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z3_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z3_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z3_t15_PhenDC3vst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 617
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 263
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 367

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
g <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z3$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")


######
# z4 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z4$samples)
colnames(des) <- levels(factor(z4$samples$group))
des


# Estimate dispersions
z4_glm <- estimateDisp(z4, des)
sqrt(z4_glm$common.disp) # 0.5214181


# Plot BCVs versus abundance
plotBCV(z4_glm)


# Fit negative bionomial GLM
z4_fit <- glmFit(z4_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool4 - t0_no_Pool4,
t15_PDSvst0_no = t15_PDS_Pool4 - t0_no_Pool4,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool4 - t0_no_Pool4,
t15_PDSvst15_DMSO = t15_PDS_Pool4 - t15_DMSO_Pool4,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool4 - t15_DMSO_Pool4,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool4 - t15_PDS_Pool4,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z4_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z4_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z4_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z4_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z4_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z4_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 258

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 317

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 205

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 2

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 107

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 90


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z4_t15_PDSvst0_no_cpm <- data.table(cpm(z4)[, grepl("t15_PDS|t0_no", colnames(cpm(z4)))], keep.rownames=TRUE)
z4_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool4_1) + log2(t0_no_Pool4_2) + log2(t0_no_Pool4_3))/3]
z4_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z4_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z4_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z4_t15_PDSvst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z4_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z4)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z4)))], keep.rownames=TRUE)
z4_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool4_1) + log2(t0_no_Pool4_2) + log2(t0_no_Pool4_3))/3]
z4_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z4_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z4_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z4_t15_PhenDC3vst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 171
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 81
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 95

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
g <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z4$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")

```



# Analysis of count table (Pools 3 and 4) using the data from the LIMS

```R
library(edgeR)
library(data.table)
library(ggplot2)
library(VennDiagram)
library(reshape)


# Enlarge the view width when printing tables
options(width = 300)


# Load table of counts into edgeR
data <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20160902/20160902_counts_lims.txt", header = T)
dim(data) #  87342    25


# Add first column to rownames
rownames(data) <- data[,1]
data <- data[2:25]
dim(data) # 87342    24

# Change to a DGE object
z <- DGEList(counts=data)

# How many counts are of each Pool?
reads_total <- sum(z$counts) # 141838991
reads_total_pool3 <- sum(z[,grepl("pool3", colnames(z$counts))]$counts) # 70120322
reads_total_pool4 <- sum(z[,grepl("pool4", colnames(z$counts))]$counts) # 71718669
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts)
  reads_pool_pct <- round(100*reads_pool/reads_total, 2)
  reads_pool_pool3 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool3", colnames(z$counts))]$counts)
  reads_pool_pct_pool3 <- round(100*reads_pool_pool3/reads_total_pool3, 2)
  reads_pool_pool4 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("pool4", colnames(z$counts))]$counts)
  reads_pool_pct_pool4 <- round(100*reads_pool_pool4/reads_total_pool4, 2)
  hps_pool <- length(rowSums(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts))
  print(sprintf("%s   %s   %s   %s   %s   %s   %s   %s", p, reads_pool, reads_pool_pct, reads_pool_pool3, reads_pool_pct_pool3, reads_pool_pool4, reads_pool_pct_pool4, hps_pool))
}

#[1] "Pool1   228597   0.16   136233   0.19   92364   0.13   6905"
#[1] "Pool2   437755   0.31   314098   0.45   123657   0.17   8569"
#[1] "Pool3   55986108   39.47   54337682   77.49   1648426   2.3   9518"
#[1] "Pool4   72494557   51.11   10211199   14.56   62283358   86.84   8384"
#[1] "Pool5   1544033   1.09   281649   0.4   1262384   1.76   7419"
#[1] "Pool6   219957   0.16   110041   0.16   109916   0.15   2843"
#[1] "Pool7   1082139   0.76   790302   1.13   291837   0.41   7554"
#[1] "Pool8   7181587   5.06   3336023   4.76   3845564   5.36   9569"
#[1] "Pool9   1639584   1.16   270731   0.39   1368853   1.91   8809"
#[1] "Pool10   221497   0.16   104486   0.15   117011   0.16   7811"
#[1] "Pool11   179618   0.13   50070   0.07   129548   0.18   550"
#[1] "Pool12   623559   0.44   177808   0.25   445751   0.62   9411"

# There is way less Pool 8 than in 20160627_counts.txt and 20160629_counts.txt, now ~5%


# Change column labels z$counts, change row labels z$samples, add group to z$samples, add Replicate to z$samples
treatments <- c(rep("no", 6), rep("DMSO", 6), rep("PDS", 6), rep("PhenDC3", 6))
timepoints <- c(rep("t0", 6), rep("t15", 18))
pools <- rep(c(rep("Pool3", 3), rep("Pool4", 3)), 4)
replicates <- rep(c("1", "2", "3"), 8)

colnames(z$counts) <- paste(timepoints, treatments, pools, replicates, sep="_")
rownames(z$samples) <- paste(timepoints, treatments, pools, replicates, sep="_")
z$samples$group <- paste(timepoints, treatments, pools, sep="_")
z$samples$Replicate <- replicates


# Select Pools 3 and 4 as z3 and z4, and redefine z3$samples$lib.size and z4$samples$lib.size
z3 <- z[grepl("Pool3$", rownames(z$counts)), grepl("Pool3", colnames(z$counts))]
z3$samples$lib.size <- as.vector(colSums(z3$counts))
z4 <- z[grepl("Pool4$", rownames(z$counts)), grepl("Pool4", colnames(z$counts))]
z4$samples$lib.size <- as.vector(colSums(z4$counts))

par(mfrow=c(2,1))
barplot(colSums(z$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z$counts)[rowSums(z$counts) > 600000], decreasing=T)
#MKKS__sherwood__3__3_Pool4     CLCA2__sensor__1_Pool4 C14orf169__sensor__1_Pool9 TANK__sherwood__3__3_Pool4
#                   1216033                     995840                     926447                     604401


# Pool content table
z_plot <- data.table(z$counts)
setcolorder(z_plot, c("t0_no_Pool3_1", "t0_no_Pool3_2", "t0_no_Pool3_3", "t15_DMSO_Pool3_1", "t15_DMSO_Pool3_2", "t15_DMSO_Pool3_3", "t15_PDS_Pool3_1", "t15_PDS_Pool3_2", "t15_PDS_Pool3_3", "t15_PhenDC3_Pool3_1", "t15_PhenDC3_Pool3_2", "t15_PhenDC3_Pool3_3", "t0_no_Pool4_1", "t0_no_Pool4_2", "t0_no_Pool4_3", "t15_DMSO_Pool4_1", "t15_DMSO_Pool4_2", "t15_DMSO_Pool4_3", "t15_PDS_Pool4_1", "t15_PDS_Pool4_2", "t15_PDS_Pool4_3", "t15_PhenDC3_Pool4_1", "t15_PhenDC3_Pool4_2", "t15_PhenDC3_Pool4_3"))
z_plot[, pool := as.numeric(sapply(rownames(z), function(x) gsub("Pool", "", tail(unlist(strsplit(x, "_")), n=1))))]

z_plot_pcts <- z_plot[, .(t0_no_Pool3_1 = 100*sum(t0_no_Pool3_1)/sum(z_plot[, t0_no_Pool3_1]),
t0_no_Pool3_2 = 100*sum(t0_no_Pool3_2)/sum(z_plot[, t0_no_Pool3_2]),
t0_no_Pool3_3 = 100*sum(t0_no_Pool3_3)/sum(z_plot[, t0_no_Pool3_3]),
t15_DMSO_Pool3_1 = 100*sum(t15_DMSO_Pool3_1)/sum(z_plot[, t15_DMSO_Pool3_1]),
t15_DMSO_Pool3_2 = 100*sum(t15_DMSO_Pool3_2)/sum(z_plot[, t15_DMSO_Pool3_2]),
t15_DMSO_Pool3_3 = 100*sum(t15_DMSO_Pool3_3)/sum(z_plot[, t15_DMSO_Pool3_3]),
t15_PDS_Pool3_1 = 100*sum(t15_PDS_Pool3_1)/sum(z_plot[, t15_PDS_Pool3_1]),
t15_PDS_Pool3_2 = 100*sum(t15_PDS_Pool3_2)/sum(z_plot[, t15_PDS_Pool3_2]),
t15_PDS_Pool3_3 = 100*sum(t15_PDS_Pool3_3)/sum(z_plot[, t15_PDS_Pool3_3]),
t15_PhenDC3_Pool3_1 = 100*sum(t15_PhenDC3_Pool3_1)/sum(z_plot[, t15_PhenDC3_Pool3_1]),
t15_PhenDC3_Pool3_2 = 100*sum(t15_PhenDC3_Pool3_2)/sum(z_plot[, t15_PhenDC3_Pool3_2]),
t15_PhenDC3_Pool3_3 = 100*sum(t15_PhenDC3_Pool3_3)/sum(z_plot[, t15_PhenDC3_Pool3_3]),
t0_no_Pool4_1 = 100*sum(t0_no_Pool4_1)/sum(z_plot[, t0_no_Pool4_1]),
t0_no_Pool4_2 = 100*sum(t0_no_Pool4_2)/sum(z_plot[, t0_no_Pool4_2]),
t0_no_Pool4_3 = 100*sum(t0_no_Pool4_3)/sum(z_plot[, t0_no_Pool4_3]),
t15_DMSO_Pool4_1 = 100*sum(t15_DMSO_Pool4_1)/sum(z_plot[, t15_DMSO_Pool4_1]),
t15_DMSO_Pool4_2 = 100*sum(t15_DMSO_Pool4_2)/sum(z_plot[, t15_DMSO_Pool4_2]),
t15_DMSO_Pool4_3 = 100*sum(t15_DMSO_Pool4_3)/sum(z_plot[, t15_DMSO_Pool4_3]),
t15_PDS_Pool4_1 = 100*sum(t15_PDS_Pool4_1)/sum(z_plot[, t15_PDS_Pool4_1]),
t15_PDS_Pool4_2 = 100*sum(t15_PDS_Pool4_2)/sum(z_plot[, t15_PDS_Pool4_2]),
t15_PDS_Pool4_3 = 100*sum(t15_PDS_Pool4_3)/sum(z_plot[, t15_PDS_Pool4_3]),
t15_PhenDC3_Pool4_1 = 100*sum(t15_PhenDC3_Pool4_1)/sum(z_plot[, t15_PhenDC3_Pool4_1]),
t15_PhenDC3_Pool4_2 = 100*sum(t15_PhenDC3_Pool4_2)/sum(z_plot[, t15_PhenDC3_Pool4_2]),
t15_PhenDC3_Pool4_3 = 100*sum(t15_PhenDC3_Pool4_3)/sum(z_plot[, t15_PhenDC3_Pool4_3])),
keyby = pool]

write.table(z_plot_pcts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_Pool4_library_content_table_lims.txt", quote = FALSE, sep = "\t", row.names = FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_Pool4_library_content_table_lims.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")


# Pool content plot
z_plot_pcts_melt <- melt(z_plot_pcts, id = "pool", variable.name = "library", value.name = "pct")

gg <- ggplot(z_plot_pcts_melt[order(-pool)], aes(x = library, y = pct, fill = factor(pool))) +
geom_bar(stat="identity") +
xlab("") +
ylab("% Reads") +
theme_classic() +
scale_fill_discrete(name="Pool") +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_text(size = 16)) +
scale_x_discrete(labels = paste(paste(colnames(z_plot)[1:24], "(n =", as.character(colSums(z_plot)[1:24])), ")", sep=""))

ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_Pool4_library_content_plot_lims.pdf", width = 16/2.54, height = 16/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_Pool4_library_content_plot_lims.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures/")

# As we observed before the data went through the LIMS: t15_PhenDC3_Pool3_1 and t15_PhenDC3_Pool3_3 have a lot of Pool4.



# Write raw counts to table (Pools 3 and 4)
write.table(z3$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_counts_lims.txt", quote = FALSE, sep = "\t")
write.table(z4$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_counts_lims.txt", quote = FALSE, sep = "\t")

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool3_counts_lims.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160908_Pool4_counts_lims.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/tables/")


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z3$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z3$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z3$counts)[rowSums(z3$counts) > 150000], decreasing=T)
#TP53__sherwood_1u__1__1_Pool3
#                       164474

par(mfrow=c(2,1))
barplot(colSums(z4$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z4$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z4$counts)[rowSums(z4$counts) > 600000], decreasing=T)
#MKKS__sherwood__3__3_Pool4     CLCA2__sensor__1_Pool4
#                   1024896                     830116


# Make MDS plots to visualise relationships between replicate samples

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_mds_lims.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z3, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("topleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool3_mds_lims.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures")

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_mds_lims.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z4, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("bottomleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160908_Pool4_mds_lims.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160902/figures")



######
# z3 #
######


######
# z4 #
######




```






# Analysis of count table (Pools 6 and 7)

```R
library(edgeR)
library(data.table)
library(ggplot2)
library(VennDiagram)
library(reshape)


# Enlarge the view width when printing tables
options(width = 300)


# Load table of counts into edgeR
data <- read.table("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/data/20160920/20160920_counts.txt", header = T)
dim(data) #  87802   25


# Add first column to rownames
rownames(data) <- data[,1]
data <- data[2:25]
dim(data) # 87802    24


# Change to a DGE object
z <- DGEList(counts=data)


# How many counts are of each Pool?
reads_total <- sum(z$counts) # 234838496
reads_total_pool6 <- sum(z[,grepl("P6", colnames(z$counts))]$counts) # 107473706
reads_total_pool7 <- sum(z[,grepl("P7", colnames(z$counts))]$counts) # 127364790
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts)
  reads_pool_pct <- round(100*reads_pool/reads_total, 2)
  reads_pool_pool6 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("P6", colnames(z$counts))]$counts)
  reads_pool_pct_pool6 <- round(100*reads_pool_pool6/reads_total_pool6, 2)
  reads_pool_pool7 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("P7", colnames(z$counts))]$counts)
  reads_pool_pct_pool7 <- round(100*reads_pool_pool7/reads_total_pool7, 2)
  hps_pool <- length(rowSums(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),]$counts))
  print(sprintf("%s   %s   %s   %s   %s   %s   %s   %s", p, reads_pool, reads_pool_pct, reads_pool_pool6, reads_pool_pct_pool6, reads_pool_pool7, reads_pool_pct_pool7, hps_pool))
}

#[1] "Pool1   308206   0.13   119480   0.11   188726   0.15   2918"
#[1] "Pool2   1255476   0.53   118727   0.11   1136749   0.89   6976"
#[1] "Pool3   3643798   1.55   2013803   1.87   1629995   1.28   8570"
#[1] "Pool4   10706354   4.56   10358135   9.64   348219   0.27   7676"
#[1] "Pool5   2406918   1.02   1556275   1.45   850643   0.67   8410"
#[1] "Pool6   87371362   37.2   85638324   79.68   1733038   1.36   9544"
#[1] "Pool7   113115026   48.17   1085004   1.01   112030022   87.96   9553"
#[1] "Pool8   11129990   4.74   4075485   3.79   7054505   5.54   9566"
#[1] "Pool9   1411386   0.6   669160   0.62   742226   0.58   7553"
#[1] "Pool10   1325447   0.56   595535   0.55   729912   0.57   8669"
#[1] "Pool11   961647   0.41   518448   0.48   443199   0.35   1010"
#[1] "Pool12   1202886   0.51   725330   0.67   477556   0.37   7357"


# As in 20160902_counts.txt above, there is also way less Pool 8 than in 20160627_counts.txt and 20160629_counts.txt, also now ~5%.


# Change column labels z$counts, change row labels z$samples, add group to z$samples, add Replicate to z$samples
treatments <- rep(c(rep("no", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), 2)
timepoints <- rep(c(rep("t0", 3), rep("t15", 9)), 2)
pools <- c(rep("Pool6", 12), rep("Pool7", 12))
replicates <- rep(c("1", "2", "3"), 8)

colnames(z$counts) <- paste(timepoints, treatments, pools, replicates, sep="_")
rownames(z$samples) <- paste(timepoints, treatments, pools, replicates, sep="_")
z$samples$group <- paste(timepoints, treatments, pools, sep="_")
z$samples$Replicate <- replicates


# Select Pools 6 and 7 as z6 and z7, and redefine z6$samples$lib.size and z7$samples$lib.size
z6 <- z[grepl("Pool6$", rownames(z$counts)), grepl("Pool6", colnames(z$counts))]
z6$samples$lib.size <- as.vector(colSums(z6$counts))
z7 <- z[grepl("Pool7$", rownames(z$counts)), grepl("Pool7", colnames(z$counts))]
z7$samples$lib.size <- as.vector(colSums(z7$counts))

# When inspecting z6$samples, t0_no_Pool6_3 and perhaps also t0_no_Pool6_2 have considerably less reads than the rest of libraries. Especially t0_no_Pool6_3 might need to be removed from the downstream analysis.
# z7$samples looks ok.
# z3$samples was also uneven (see above)
# z1, z2, z5, z10 from before looked even.

par(mfrow=c(2,1))
barplot(colSums(z$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z$counts)[rowSums(z$counts) > 1000000], decreasing=T)
#TAOK1__4__3_Pool6
#          1120156

# There seems to be a contamination of hairpins from Pool4 in t0_no_Pool6_3 and t0_no_Pool6_2, e.g.:
z$counts[z$counts[, 3] > 50000,]

# Further investigation - let's look at the distribution of reads in the three replicates of t0 pool6
reads_total_t0_no_Pool6_1 <- sum(z[,grepl("t0_no_Pool6_1", colnames(z$counts))]$counts) # 10682665
reads_total_t0_no_Pool6_2 <- sum(z[,grepl("t0_no_Pool6_2", colnames(z$counts))]$counts) # 9436887
reads_total_t0_no_Pool6_3 <- sum(z[,grepl("t0_no_Pool6_3", colnames(z$counts))]$counts) # 8813080
for (i in 1:12){
  p <- sprintf("Pool%i", i)
  reads_pool_t0_no_Pool6_1 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("t0_no_Pool6_1", colnames(z$counts))]$counts)
  reads_pool_pct_t0_no_Pool6_1 <- round(100*reads_pool_t0_no_Pool6_1/reads_total_t0_no_Pool6_1, 2)
  reads_pool_t0_no_Pool6_2 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("t0_no_Pool6_2", colnames(z$counts))]$counts)
  reads_pool_pct_t0_no_Pool6_2 <- round(100*reads_pool_t0_no_Pool6_2/reads_total_t0_no_Pool6_2, 2)
  reads_pool_t0_no_Pool6_3 <- sum(z[grepl(paste(p, "$", sep=""), rownames(z$counts)),grepl("t0_no_Pool6_3", colnames(z$counts))]$counts)
  reads_pool_pct_t0_no_Pool6_3 <- round(100*reads_pool_t0_no_Pool6_3/reads_total_t0_no_Pool6_3, 2)
  print(sprintf("%s   %s   %s   %s   %s   %s   %s", p, reads_pool_t0_no_Pool6_1 , reads_pool_pct_t0_no_Pool6_1 , reads_pool_t0_no_Pool6_2, reads_pool_pct_t0_no_Pool6_2, reads_pool_t0_no_Pool6_3, reads_pool_pct_t0_no_Pool6_3))
}

#[1] "Pool1   9843   0.09   15401   0.16   10915   0.12"
#[1] "Pool2   8738   0.08   40663   0.43   12288   0.14"
#[1] "Pool3   10455   0.1   1887596   20   31898   0.36"
#[1] "Pool4   10811   0.1   1896823   20.1   8359317   94.85"
#[1] "Pool5   120999   1.13   275795   2.92   148900   1.69"
#[1] "Pool6   10087228   94.43   2044405   21.66   16083   0.18"
#[1] "Pool7   96392   0.9   63114   0.67   27618   0.31"
#[1] "Pool8   124743   1.17   2881198   30.53   14263   0.16"
#[1] "Pool9   45170   0.42   123660   1.31   151541   1.72"
#[1] "Pool10   51667   0.48   86109   0.91   4236   0.05"
#[1] "Pool11   49431   0.46   23389   0.25   15311   0.17"
#[1] "Pool12   67188   0.63   98734   1.05   20710   0.23"

# t0_no_Pool6_3: 95% of reads are Pool4, only 0.18 are Pool6
# t0_no_Pool6_2: 20% (Pool3), 20% (Pool4), 22% (Pool6) and 31% (Pool8)


# Pool content table
z_plot <- data.table(z$counts)
z_plot[, pool := as.numeric(sapply(rownames(z), function(x) gsub("Pool", "", tail(unlist(strsplit(x, "_")), n=1))))]
#z_plot[, .(t0_no_Pool6_1 = 100*sum(t0_no_Pool6_1)/sum(z_plot[, t0_no_Pool6_1]), t0_no_Pool6_2 = 100*sum(t0_no_Pool6_2)/sum(z_plot[, t0_no_Pool6_2]), t0_no_Pool6_3 = 100*sum(t0_no_Pool6_3)/sum(z_plot[, t0_no_Pool6_3])), keyby = pool]
#z_plot[, lapply(.SD, sum), keyby = pool]
#z_plot[, lapply(.SD, function(x){100*sum(x)}), keyby = pool]

z_plot_pcts <- z_plot[, .(t0_no_Pool6_1 = 100*sum(t0_no_Pool6_1)/sum(z_plot[, t0_no_Pool6_1]),
t0_no_Pool6_2 = 100*sum(t0_no_Pool6_2)/sum(z_plot[, t0_no_Pool6_2]),
t0_no_Pool6_3 = 100*sum(t0_no_Pool6_3)/sum(z_plot[, t0_no_Pool6_3]),
t15_DMSO_Pool6_1 = 100*sum(t15_DMSO_Pool6_1)/sum(z_plot[, t15_DMSO_Pool6_1]),
t15_DMSO_Pool6_2 = 100*sum(t15_DMSO_Pool6_2)/sum(z_plot[, t15_DMSO_Pool6_2]),
t15_DMSO_Pool6_3 = 100*sum(t15_DMSO_Pool6_3)/sum(z_plot[, t15_DMSO_Pool6_3]),
t15_PDS_Pool6_1 = 100*sum(t15_PDS_Pool6_1)/sum(z_plot[, t15_PDS_Pool6_1]),
t15_PDS_Pool6_2 = 100*sum(t15_PDS_Pool6_2)/sum(z_plot[, t15_PDS_Pool6_2]),
t15_PDS_Pool6_3 = 100*sum(t15_PDS_Pool6_3)/sum(z_plot[, t15_PDS_Pool6_3]),
t15_PhenDC3_Pool6_1 = 100*sum(t15_PhenDC3_Pool6_1)/sum(z_plot[, t15_PhenDC3_Pool6_1]),
t15_PhenDC3_Pool6_2 = 100*sum(t15_PhenDC3_Pool6_2)/sum(z_plot[, t15_PhenDC3_Pool6_2]),
t15_PhenDC3_Pool6_3 = 100*sum(t15_PhenDC3_Pool6_3)/sum(z_plot[, t15_PhenDC3_Pool6_3]),
t0_no_Pool7_1 = 100*sum(t0_no_Pool7_1)/sum(z_plot[, t0_no_Pool7_1]),
t0_no_Pool7_2 = 100*sum(t0_no_Pool7_2)/sum(z_plot[, t0_no_Pool7_2]),
t0_no_Pool7_3 = 100*sum(t0_no_Pool7_3)/sum(z_plot[, t0_no_Pool7_3]),
t15_DMSO_Pool7_1 = 100*sum(t15_DMSO_Pool7_1)/sum(z_plot[, t15_DMSO_Pool7_1]),
t15_DMSO_Pool7_2 = 100*sum(t15_DMSO_Pool7_2)/sum(z_plot[, t15_DMSO_Pool7_2]),
t15_DMSO_Pool7_3 = 100*sum(t15_DMSO_Pool7_3)/sum(z_plot[, t15_DMSO_Pool7_3]),
t15_PDS_Pool7_1 = 100*sum(t15_PDS_Pool7_1)/sum(z_plot[, t15_PDS_Pool7_1]),
t15_PDS_Pool7_2 = 100*sum(t15_PDS_Pool7_2)/sum(z_plot[, t15_PDS_Pool7_2]),
t15_PDS_Pool7_3 = 100*sum(t15_PDS_Pool7_3)/sum(z_plot[, t15_PDS_Pool7_3]),
t15_PhenDC3_Pool7_1 = 100*sum(t15_PhenDC3_Pool7_1)/sum(z_plot[, t15_PhenDC3_Pool7_1]),
t15_PhenDC3_Pool7_2 = 100*sum(t15_PhenDC3_Pool7_2)/sum(z_plot[, t15_PhenDC3_Pool7_2]),
t15_PhenDC3_Pool7_3 = 100*sum(t15_PhenDC3_Pool7_3)/sum(z_plot[, t15_PhenDC3_Pool7_3])),
keyby = pool]

write.table(z_plot_pcts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_Pool7_library_content_table.txt", quote = FALSE, sep = "\t", row.names = FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_Pool7_library_content_table.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")


# Pool content plot
z_plot_pcts_melt <- melt(z_plot_pcts, id = "pool", variable.name = "library", value.name = "pct")

gg <- ggplot(z_plot_pcts_melt[order(-pool)], aes(x = library, y = pct, fill = factor(pool))) +
geom_bar(stat="identity") +
xlab("") +
ylab("% Reads") +
theme_classic() +
scale_fill_discrete(name="Pool") +
theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.y = element_text(size = 16)) +
scale_x_discrete(labels = paste(paste(colnames(z$counts), "(n =", as.character(colSums(z$counts))), ")", sep=""))

ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_Pool7_library_content_plot.pdf", width = 16/2.54, height = 16/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_Pool7_library_content_plot.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures/")


# Write raw counts to table (Pools 6 and 7)
write.table(z6$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_counts.txt", quote = FALSE, sep = "\t")
write.table(z7$counts, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_counts.txt", quote = FALSE, sep = "\t")

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_counts.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")


# Plot number of hairpins that could be matched per sample
# and total for each hairpin across all samples
par(mfrow=c(2,1))
barplot(colSums(z6$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z6$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z6$counts)[rowSums(z6$counts) > 1000000], decreasing=T)
#TAOK1__4__3_Pool6
#          1104848

par(mfrow=c(2,1))
barplot(colSums(z7$counts), las=2, main="Counts per index", cex.names=0.5, cex.axis=0.8)
barplot(rowSums(z7$counts), las=2, main="Counts per hairpin", cex.names=0.5, cex.axis=0.8, axisnames = FALSE)

sort(rowSums(z7$counts)[rowSums(z7$counts) > 600000], decreasing=T)
#KIAA1217__1__1_Pool7
#              785066


# Make MDS plots to visualise relationships between replicate samples

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z6, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("topright", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures")

pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_mds.pdf", width = 16/2.54, height = 16/2.54)
g <- plotMDS(z7, labels = c(rep("t0", 3), rep("DMSO", 3), rep("PDS", 3), rep("PhenDC3", 3)), col = c(rep("black", 3), rep("deepskyblue3", 3), rep("red3", 3), rep("forestgreen", 3)), xlab = "Dimension 1", ylab = "Dimension 2",  gene.selection = "common")
legend("bottomleft", legend=c("t0", "DMSO", "PDS", "PhenDC3"), col=c("black", "deepskyblue3", "red3", "forestgreen"), pch=15)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_mds.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures")



######
# z6 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z6$samples)
colnames(des) <- levels(factor(z6$samples$group))
des


# Estimate dispersions
z6_glm <- estimateDisp(z6, des)
sqrt(z6_glm$common.disp) # 0.3883824


# Plot BCVs versus abundance
plotBCV(z6_glm)


# Fit negative bionomial GLM
z6_fit <- glmFit(z6_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool6 - t0_no_Pool6,
t15_PDSvst0_no = t15_PDS_Pool6 - t0_no_Pool6,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool6 - t0_no_Pool6,
t15_PDSvst15_DMSO = t15_PDS_Pool6 - t15_DMSO_Pool6,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool6 - t15_DMSO_Pool6,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool6 - t15_PDS_Pool6,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z6_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z6_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z6_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z6_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z6_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z6_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 366

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 807

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 420

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 7

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 1118

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 1298


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z6_t15_PDSvst0_no_cpm <- data.table(cpm(z6)[, grepl("t15_PDS|t0_no", colnames(cpm(z6)))], keep.rownames=TRUE)
z6_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool6_1) + log2(t0_no_Pool6_2) + log2(t0_no_Pool6_3))/3]
z6_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z6_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z6_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z6_t15_PDSvst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z6_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z6)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z6)))], keep.rownames=TRUE)
z6_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool6_1) + log2(t0_no_Pool6_2) + log2(t0_no_Pool6_3))/3]
z6_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z6_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z6_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z6_t15_PhenDC3vst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 281
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 84
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 130

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool6_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
g <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z6$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool6_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures/")




######
# z6 # without t0_no_Pool6_2 and t0_no_Pool6_3
######


######
# z7 #
######

# Differential representation analysis.
# Set up design matrix for GLM.
des <- model.matrix(~ 0 + group, data = z7$samples)
colnames(des) <- levels(factor(z7$samples$group))
des


# Estimate dispersions
z7_glm <- estimateDisp(z7, des)
sqrt(z7_glm$common.disp) # 0.3803361


# Plot BCVs versus abundance
plotBCV(z7_glm)


# Fit negative bionomial GLM
z7_fit <- glmFit(z7_glm, des)


# Define matrix of contrasts
my.contrasts <- makeContrasts(
t15_DMSOvst0_no = t15_DMSO_Pool7 - t0_no_Pool7,
t15_PDSvst0_no = t15_PDS_Pool7 - t0_no_Pool7,
t15_PhenDC3vst0_no = t15_PhenDC3_Pool7 - t0_no_Pool7,
t15_PDSvst15_DMSO = t15_PDS_Pool7 - t15_DMSO_Pool7,
t15_PhenDC3vst15_DMSO = t15_PhenDC3_Pool7 - t15_DMSO_Pool7,
t15_PhenDC3vst15_PDS = t15_PhenDC3_Pool7 - t15_PDS_Pool7,
levels=des)


# Comparisons t15 vs t0 and within t15
# Carry out Likelihood ratio tests
lrt_t15_DMSOvst0_no <- glmLRT(z7_fit, contrast=my.contrasts[,"t15_DMSOvst0_no"])
lrt_t15_PDSvst0_no <- glmLRT(z7_fit, contrast=my.contrasts[,"t15_PDSvst0_no"])
lrt_t15_PhenDC3vst0_no <- glmLRT(z7_fit, contrast=my.contrasts[,"t15_PhenDC3vst0_no"])
lrt_t15_PDSvst15_DMSO <- glmLRT(z7_fit, contrast=my.contrasts[,"t15_PDSvst15_DMSO"])
lrt_t15_PhenDC3vst15_DMSO <- glmLRT(z7_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_DMSO"])
lrt_t15_PhenDC3vst15_PDS <- glmLRT(z7_fit, contrast=my.contrasts[,"t15_PhenDC3vst15_PDS"])


# Show top ranked hairpins
topTags(lrt_t15_DMSOvst0_no)
topTags(lrt_t15_PDSvst0_no)
topTags(lrt_t15_PhenDC3vst0_no)
topTags(lrt_t15_PDSvst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_DMSO)
topTags(lrt_t15_PhenDC3vst15_PDS)


# Select hairpins with FDR < 0.05 to highlight on plot
thresh <- 0.05

top_t15_DMSOvst0_no <- topTags(lrt_t15_DMSOvst0_no, n=Inf)
topids_t15_DMSOvst0_no <- rownames(top_t15_DMSOvst0_no$table[top_t15_DMSOvst0_no$table$FDR < thresh,])
length(topids_t15_DMSOvst0_no) # 887

top_t15_PDSvst0_no <- topTags(lrt_t15_PDSvst0_no, n=Inf)
topids_t15_PDSvst0_no <- rownames(top_t15_PDSvst0_no$table[top_t15_PDSvst0_no$table$FDR < thresh,])
length(topids_t15_PDSvst0_no) # 1262

top_t15_PhenDC3vst0_no <- topTags(lrt_t15_PhenDC3vst0_no, n=Inf)
topids_t15_PhenDC3vst0_no <- rownames(top_t15_PhenDC3vst0_no$table[top_t15_PhenDC3vst0_no$table$FDR < thresh,])
length(topids_t15_PhenDC3vst0_no) # 2178

top_t15_PDSvst15_DMSO <- topTags(lrt_t15_PDSvst15_DMSO, n=Inf)
topids_t15_PDSvst15_DMSO <- rownames(top_t15_PDSvst15_DMSO$table[top_t15_PDSvst15_DMSO$table$FDR < thresh,])
length(topids_t15_PDSvst15_DMSO) # 6

top_t15_PhenDC3vst15_DMSO <- topTags(lrt_t15_PhenDC3vst15_DMSO, n=Inf)
topids_t15_PhenDC3vst15_DMSO <- rownames(top_t15_PhenDC3vst15_DMSO$table[top_t15_PhenDC3vst15_DMSO$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_DMSO) # 1647

top_t15_PhenDC3vst15_PDS <- topTags(lrt_t15_PhenDC3vst15_PDS, n=Inf)
topids_t15_PhenDC3vst15_PDS <- rownames(top_t15_PhenDC3vst15_PDS$table[top_t15_PhenDC3vst15_PDS$table$FDR < thresh,])
length(topids_t15_PhenDC3vst15_PDS) # 1398


# Write LogFC and FDR tables
write.table(data.table(as.data.frame(top_t15_DMSOvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_DMSOvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_DMSOvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PDSvst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PDSvst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst0_no), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PhenDC3vst0_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PhenDC3vst0_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PDSvst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PDSvst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_DMSO), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PhenDC3vst15_DMSO_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

write.table(data.table(as.data.frame(top_t15_PhenDC3vst15_PDS), keep.rownames=TRUE)[order(-logFC),.(rn, logFC, FDR)], file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt", quote = FALSE, sep = "\t", row.names=FALSE)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_t15_PhenDC3vst15_PDS_logFCdecreasing_FDR.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")


# Plot logFC versus logCPM
plotSmear(lrt_t15_DMSOvst0_no, de.tags=topids_t15_DMSOvst0_no, main = "t15_DMSO vs t0_no")

plotSmear(lrt_t15_PDSvst0_no, de.tags=topids_t15_PDSvst0_no, main = "t15_PDS vs t0_no")
z7_t15_PDSvst0_no_cpm <- data.table(cpm(z7)[, grepl("t15_PDS|t0_no", colnames(cpm(z7)))], keep.rownames=TRUE)
z7_t15_PDSvst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool7_1) + log2(t0_no_Pool7_2) + log2(t0_no_Pool7_3))/3]
z7_t15_PDSvst0_no_cpm[, log2FC := lrt_t15_PDSvst0_no$table$logFC]
z7_t15_PDSvst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PDSvst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PDS and DMSO", "PDS only"), "not differentially abundant")]
z7_t15_PDSvst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z7_t15_PDSvst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "red3"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_log2t0_log2FC_PDS_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_log2t0_log2FC_PDS_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures/")

plotSmear(lrt_t15_PhenDC3vst0_no, de.tags=topids_t15_PhenDC3vst0_no, main = "t15_PhenDC3 vs t0_no")
z7_t15_PhenDC3vst0_no_cpm <- data.table(cpm(z7)[, grepl("t15_PhenDC3|t0_no", colnames(cpm(z7)))], keep.rownames=TRUE)
z7_t15_PhenDC3vst0_no_cpm[, log2cpmt0 := (log2(t0_no_Pool7_1) + log2(t0_no_Pool7_2) + log2(t0_no_Pool7_3))/3]
z7_t15_PhenDC3vst0_no_cpm[, log2FC := lrt_t15_PhenDC3vst0_no$table$logFC]
z7_t15_PhenDC3vst0_no_cpm[, hits := ifelse(rn %in% topids_t15_PhenDC3vst0_no, ifelse(rn %in% topids_t15_DMSOvst0_no, "PhenDC3 and DMSO", "PhenDC3 only"), "not differentially abundant")]
z7_t15_PhenDC3vst0_no_cpm[, order := ifelse(hits == "not differentially abundant", 1, 2)]

gg <- ggplot(z7_t15_PhenDC3vst0_no_cpm[log2cpmt0 != -Inf][order(order)], aes(x = log2cpmt0, y = log2FC, colour = hits)) +
geom_point(size=0.5) +
xlab(expression("log"[2]*"(t0)")) +
ylab(expression("log"[2]*"(t15/t0)")) +
theme_bw() +
scale_colour_manual(name="",values = c("grey", "deepskyblue3", "forestgreen"))
ggsave("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_log2t0_log2FC_PhenDC3_DMSO.pdf", width = 16/2.54, height = 10/2.54)
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_log2t0_log2FC_PhenDC3_DMSO.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures/")

plotSmear(lrt_t15_PDSvst15_DMSO, de.tags=topids_t15_PDSvst15_DMSO, main = "t15_PDS vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_DMSO, de.tags=topids_t15_PhenDC3vst15_DMSO, main = "t15_PhenDC3 vs t15_DMSO")
plotSmear(lrt_t15_PhenDC3vst15_PDS, de.tags=topids_t15_PhenDC3vst15_PDS, main = "t15_PhenDC3 vs t15_PDS")


# Intersect lists of topTags
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)) # 662
length(intersect(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)) # 398
length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)) # 565

write(topids_t15_DMSOvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_topids_t15_DMSOvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_topids_t15_DMSOvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")
write(topids_t15_PDSvst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_topids_t15_PDSvst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_topids_t15_PDSvst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")
write(topids_t15_PhenDC3vst0_no, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_topids_t15_PhenDC3vst0_no.txt")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_topids_t15_PhenDC3vst0_no.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

top_t15_PDSvst0_no_PDSonly <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][!(topids_t15_PDSvst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PhenDC3vst0_no)),]
write.table(top_t15_PDSvst0_no_PDSonly, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_top_t15_PDSvst0_no_PDSonly.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_top_t15_PDSvst0_no_PDSonly.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

top_t15_PhenDC3vst0_no_PhenDC3only <- top_t15_PhenDC3vst0_no[1:length(topids_t15_PhenDC3vst0_no),][!(topids_t15_PhenDC3vst0_no %in% c(topids_t15_DMSOvst0_no, topids_t15_PDSvst0_no)),]
write.table(top_t15_PhenDC3vst0_no_PhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_top_t15_PhenDC3vst0_no_PhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_top_t15_PhenDC3vst0_no_PhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

top_t15_PDSvst0_no_PDSandPhenDC3 <- top_t15_PDSvst0_no[1:length(topids_t15_PDSvst0_no),][(topids_t15_PDSvst0_no %in% topids_t15_PhenDC3vst0_no),]
top_t15_PDSvst0_no_PDSandPhenDC3only <- top_t15_PDSvst0_no_PDSandPhenDC3[!(rownames(top_t15_PDSvst0_no_PDSandPhenDC3) %in% topids_t15_DMSOvst0_no),]
write.table(top_t15_PDSvst0_no_PDSandPhenDC3only, file = "/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_top_t15_PDSvst0_no_PDSandPhenDC3only.txt", quote = FALSE, sep = "\t")
system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/tables/20160920_Pool7_top_t15_PDSvst0_no_PDSandPhenDC3only.txt martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/tables/")

top_t15_DMSOvst0_no_DMSOonly <- top_t15_DMSOvst0_no[1:length(topids_t15_DMSOvst0_no),][!(topids_t15_DMSOvst0_no %in% c(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),]


# Venn diagram
venn.plot <- draw.triple.venn(
  area1 = length(topids_t15_PDSvst0_no),
  area2 = length(topids_t15_PhenDC3vst0_no),
  area3 = length(topids_t15_DMSOvst0_no),
  n12 = length(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no)),
  n23 = length(intersect(topids_t15_PhenDC3vst0_no, topids_t15_DMSOvst0_no)),
  n13 = length(intersect(topids_t15_PDSvst0_no, topids_t15_DMSOvst0_no)),
  n123 = length(intersect(intersect(topids_t15_PDSvst0_no, topids_t15_PhenDC3vst0_no), topids_t15_DMSOvst0_no)),
  category = c(sprintf("PDS (%i)", length(topids_t15_PDSvst0_no)), sprintf("PhenDC3 (%i)", length(topids_t15_PhenDC3vst0_no)), sprintf("DMSO (%i)", length(topids_t15_DMSOvst0_no))),
  fill = c("red3", "forestgreen", "deepskyblue3"),
  cex = 1.5,
  fontfamily = "sans",
  cat.dist = c(0.08, 0.08, 0.04),
  cat.cex = 1.5,
  cat.col = c("red3", "forestgreen", "deepskyblue3"),
  cat.fontface = "bold",
  cat.fontfamily = "sans",
  print.mode = c("raw", "percent"),
  sigdigs = 2,
  margin = 0.075)


pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_t15vst0_venn.pdf", width = 20/2.54, height = 20/2.54)
g <- grid.draw(venn.plot)
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_t15vst0_venn.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures/")


# Distribution log(counts)
pdf("/lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_t15vst0_distribution_counts.pdf")
hist(log(rowSums(z7$counts)), xlab = "log(counts)", main = "", xlim = c(0,12))
dev.off()

system("rsync --remove-source-files /lustre/sblab/martin03/repository/20160418_shRNAscreen_katie_darcie/figures/20160920_Pool7_t15vst0_distribution_counts.pdf martin03@nm149s012925:/media/itshare/research/sblab/group/public_folders/martin03/20160418_shRNAscreen_katie_darcie/20160920/figures/")

```
